<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>flirt: elastic.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<div class="nav">
<a class="el" href="dir_000000.html">home</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">ens</a>&nbsp;/&nbsp;<a class="el" href="dir_000002.html">flirtproj</a>&nbsp;/&nbsp;<a class="el" href="dir_000004.html">flirt</a></div>
<h1>elastic.c</h1><div class="fragment"><pre class="fragment">00001 <span class="comment">// (c) SW and KE, 2005</span>
00002 <span class="preprocessor">#include "<a class="code" href="elastic_8h.html">elastic.h</a>"</span>
00003 <span class="comment">//#include &lt;stdio.h&gt;</span>
00004 <span class="comment">//#include &lt;fftw3.h&gt;</span>
00005 
00006 <span class="comment">/* --------------------------------------------------------------------- */</span>
00007 <span class="keywordtype">void</span> initElasticMatrix2D(size_t m1,
00008                                                  size_t m2,
00009                                                  <span class="keywordtype">double</span> mu, 
00010                                                  <span class="keywordtype">double</span> lambda,
00011                                                  <span class="keywordtype">double</span> h1,
00012                                                  <span class="keywordtype">double</span> h2,
00013                                                  boundary_t bc,
00014                                                  <a class="code" href="structelastic_matrix__t.html">elasticMatrix</a>* pMatrix){
00015         
00016         <span class="keywordtype">int</span> k1,k2;
00017         <span class="keywordtype">double</span> ak1,ak2,ck1,ck2,sk1,sk2;
00018         <span class="keywordtype">double</span> d11,d12,d22,detD;
00019         <span class="keywordtype">double</span> lp2m   = lambda + 2 * mu;
00020         <span class="keywordtype">double</span> lpm    = lambda + mu;
00021         <span class="keywordtype">double</span> m2lp3m = -2*(lambda + 3*mu);
00022         
00023         <a class="code" href="structelastic_matrix__t.html">elasticMatrix</a> M;
00024         M       = (<a class="code" href="structelastic_matrix__t.html">elasticMatrix</a>) malloc(<span class="keyword">sizeof</span>(<a class="code" href="structelastic_matrix__t.html">elasticMatrix_t</a>));
00026 <span class="preprocessor">        #if 0</span>
00027 <span class="preprocessor"></span>        M-&gt;<a class="code" href="structelastic_matrix__t.html#o0">data</a> = createArray3D(3,m1,m2);
00028 <span class="preprocessor">        #endif</span>
00029 <span class="preprocessor"></span>        M-&gt;<a class="code" href="structelastic_matrix__t.html#o0">data</a> = createTreeStructure3D(3,m1,m2, (array1D) calloc(3*m2*m1,<span class="keyword">sizeof</span>(array_t)) );
00030         <span class="comment">/* \SB */</span>
00031         
00032         M-&gt;<a class="code" href="structelastic_matrix__t.html#o1">len</a>  = m1*m2*3;      
00033         
00034         <a class="code" href="arrays_8h.html#a3">array3D</a> invD = M-&gt;<a class="code" href="structelastic_matrix__t.html#o0">data</a>;
00035         
00036         <span class="keywordflow">if</span> (bc == PERIODIC){
00037                 <span class="comment">/* create inverse Matrix -------------------------------------------------- */</span>
00038                 <span class="keywordflow">for</span> (k1=0;k1&lt;m1;k1++){
00039                         <span class="keywordflow">for</span> (k2=0;k2&lt;m2;k2++){
00040                                 ak1 = 2*<a class="code" href="defs_8h.html#a0">PI</a>*k1/m1;
00041                                 ak2 = 2*<a class="code" href="defs_8h.html#a0">PI</a>*k2/m2;
00042                                 
00043                                 ck1 = 2*cos(ak1);
00044                                 ck2 = 2*cos(ak2);
00045                                 sk1 = sin(ak1);
00046                                 sk2 = sin(ak2);
00047                                 
00048                                 d11 = (m2lp3m + lp2m*ck1 + mu*ck2)/(h1*h1); 
00049                                 d12 = -lpm * sk1 * sk2/(h1*h2);                  
00050                                 d22 = (m2lp3m + mu*ck1 + lp2m*ck2)/(h2*h2); 
00051                                 
00052                                 <span class="comment">/* calculate determinant -------------------------------------------- */</span>
00053                                 detD = d11*d22 - d12*d12;
00054                                 
00055                                 <span class="keywordflow">if</span> (fabs(detD) &lt; 1e-15){
00056                                         <span class="comment">/* numerically zero */</span>
00057                                         invD[0][k1][k2] = invD[1][k1][k2] = invD[2][k1][k2] = 0;
00058                                 } 
00059                                 <span class="keywordflow">else</span>{
00060                                         invD[0][k1][k2] =   d22 / detD;
00061                                         invD[1][k1][k2] = - d12 / detD;
00062                                         invD[2][k1][k2] =   d11 / detD;
00063                                 }       
00064                         }
00065                 }
00066                 
00067                 *(pMatrix) = M;
00068         }
00069         <span class="keywordflow">else</span> {
00070                 printf(<span class="stringliteral">"Elastic solver currently only implemented for periodic boundary conditions!"</span>);
00071                 *(pMatrix) = NULL;
00072         }
00073 };
00074 
00075 
00076 <span class="comment">/* --------------------------------------------------------------------- */</span>
00077 <span class="keywordtype">void</span> initElasticPlan2D(size_t m1, 
00078                                            size_t m2, 
00079                                            <span class="keywordtype">double</span> alpha, 
00080                                            <span class="keywordtype">double</span> mu,
00081                                            <span class="keywordtype">double</span> lambda,
00082                                            <span class="keywordtype">double</span> h1,
00083                                            <span class="keywordtype">double</span> h2,
00084                                            boundary_t bc,
00085                                            <a class="code" href="structelastic_plan__t.html">elasticPlan</a>* pPlan)
00086 {
00087         
00088         <a class="code" href="structelastic_plan__t.html">elasticPlan</a> EP;
00089         EP = (<a class="code" href="structelastic_plan__t.html">elasticPlan</a>) malloc(<span class="keyword">sizeof</span>(<a class="code" href="structelastic_plan__t.html">elasticPlan_t</a>));
00090         
00091         initElasticMatrix2D(m1,m2, mu, lambda, h1, h2, bc, &amp;(EP-&gt;<a class="code" href="structelastic_plan__t.html#o0">M</a>));
00092 
00093         EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>     = (fftw_complex*) fftw_malloc(<span class="keyword">sizeof</span>(fftw_complex) * m1 * m2);
00094         EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>    = (fftw_complex*) fftw_malloc(<span class="keyword">sizeof</span>(fftw_complex) * m1 * m2);
00095         EP-&gt;<a class="code" href="structelastic_plan__t.html#o1">pForw</a>  = fftw_plan_dft_2d(m1, m2, EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>, EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>, FFTW_FORWARD,  FFTW_MEASURE);
00096     EP-&gt;<a class="code" href="structelastic_plan__t.html#o2">pBackw</a> = fftw_plan_dft_2d(m1, m2, EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>, EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>, FFTW_BACKWARD, FFTW_MEASURE);
00097 
00098         EP-&gt;<a class="code" href="structelastic_plan__t.html#o5">alpha</a>  = alpha;
00099         EP-&gt;<a class="code" href="structelastic_plan__t.html#o6">mu</a>     = mu;
00100         EP-&gt;<a class="code" href="structelastic_plan__t.html#o7">lambda</a> = lambda;
00101         EP-&gt;<a class="code" href="structelastic_plan__t.html#o8">dim</a>    = 2;
00102         EP-&gt;<a class="code" href="structelastic_plan__t.html#o12">m1</a>     = m1;
00103         EP-&gt;<a class="code" href="structelastic_plan__t.html#o13">m2</a>     = m2;
00104         EP-&gt;<a class="code" href="structelastic_plan__t.html#o14">m3</a>     = 1;
00105         EP-&gt;<a class="code" href="structelastic_plan__t.html#o9">h1</a>     = h1;
00106         EP-&gt;<a class="code" href="structelastic_plan__t.html#o10">h2</a>     = h2;
00107         EP-&gt;<a class="code" href="structelastic_plan__t.html#o11">h3</a>     = 0;
00108         EP-&gt;<a class="code" href="structelastic_plan__t.html#o15">bc</a>     = bc;
00109         
00110         *(pPlan) = EP;
00111 }                          
00112 
00113 
00114 <span class="comment">/* --------------------------------------------------------------------- */</span>
00115 <span class="keywordtype">void</span> printElasticPlan(<span class="keyword">const</span> <a class="code" href="structelastic_plan__t.html">elasticPlan</a> M) {
00116         
00117         printf(<span class="stringliteral">"%s %d (Build %s %s) -- \n"</span>,__FILE__,__LINE__,__DATE__,__TIME__);
00118         
00119         printf(<span class="stringliteral">"-- elasticPlan at %p\n"</span>,M);
00120         printf(<span class="stringliteral">"%30s : %p\n"</span>,<span class="stringliteral">"M-&gt;M"</span>,M-&gt;<a class="code" href="structelastic_plan__t.html#o0">M</a>);
00121         printf(<span class="stringliteral">"%30s : %p\n"</span>,<span class="stringliteral">"M-&gt;pForw"</span>,M-&gt;<a class="code" href="structelastic_plan__t.html#o1">pForw</a>);
00122         printf(<span class="stringliteral">"%30s : %p\n"</span>,<span class="stringliteral">"M-&gt;pBackw"</span>,M-&gt;<a class="code" href="structelastic_plan__t.html#o2">pBackw</a>);
00123         printf(<span class="stringliteral">"%30s : %p\n"</span>,<span class="stringliteral">"M-&gt;in"</span>,M-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>);
00124         printf(<span class="stringliteral">"%30s : %p\n"</span>,<span class="stringliteral">"M-&gt;out"</span>,M-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>);
00125         printf(<span class="stringliteral">"%30s : %g\n"</span>,<span class="stringliteral">"M-&gt;alpha"</span>,M-&gt;<a class="code" href="structelastic_plan__t.html#o5">alpha</a>);
00126         printf(<span class="stringliteral">"%30s : %g\n"</span>,<span class="stringliteral">"M-&gt;mu"</span>,M-&gt;<a class="code" href="structelastic_plan__t.html#o6">mu</a>);
00127         printf(<span class="stringliteral">"%30s : %g\n"</span>,<span class="stringliteral">"M-&gt;lambda"</span>,M-&gt;<a class="code" href="structelastic_plan__t.html#o7">lambda</a>);
00128         printf(<span class="stringliteral">"%30s : %d\n"</span>,<span class="stringliteral">"M-&gt;dim"</span>,M-&gt;<a class="code" href="structelastic_plan__t.html#o8">dim</a>);
00129         printf(<span class="stringliteral">"%30s : %g\n"</span>,<span class="stringliteral">"M-&gt;h1"</span>,M-&gt;<a class="code" href="structelastic_plan__t.html#o9">h1</a>);
00130         printf(<span class="stringliteral">"%30s : %g\n"</span>,<span class="stringliteral">"M-&gt;h2"</span>,M-&gt;<a class="code" href="structelastic_plan__t.html#o10">h2</a>);
00131         printf(<span class="stringliteral">"%30s : %g\n"</span>,<span class="stringliteral">"M-&gt;h3"</span>,M-&gt;<a class="code" href="structelastic_plan__t.html#o11">h3</a>);
00132         printf(<span class="stringliteral">"%30s : %d\n"</span>,<span class="stringliteral">"M-&gt;m1"</span>,M-&gt;<a class="code" href="structelastic_plan__t.html#o12">m1</a>);
00133         printf(<span class="stringliteral">"%30s : %d\n"</span>,<span class="stringliteral">"M-&gt;m2"</span>,M-&gt;<a class="code" href="structelastic_plan__t.html#o13">m2</a>);
00134         printf(<span class="stringliteral">"%30s : %d\n"</span>,<span class="stringliteral">"M-&gt;m3"</span>,M-&gt;<a class="code" href="structelastic_plan__t.html#o14">m3</a>);
00135         printf(<span class="stringliteral">"%30s : %d\n"</span>,<span class="stringliteral">"M-&gt;bc"</span>,M-&gt;<a class="code" href="structelastic_plan__t.html#o15">bc</a>);
00136 };
00137 
00138 
00139 <span class="comment">/* --------------------------------------------------------------------- */</span>
00140 <span class="keywordtype">void</span> solveElastic2D(<a class="code" href="structelastic_plan__t.html">elasticPlan</a> EP, 
00141                                         <span class="keywordtype">double</span>*** in, 
00142                                         <span class="keywordtype">double</span>*** out)
00143 {
00144         <span class="keywordtype">int</span> k1, k2;     
00145         <span class="keywordtype">int</span> m1 = EP-&gt;<a class="code" href="structelastic_plan__t.html#o12">m1</a>;
00146         <span class="keywordtype">int</span> m2 = EP-&gt;<a class="code" href="structelastic_plan__t.html#o13">m2</a>;
00147         <span class="keywordtype">int</span> m12 = m1*m2;
00148         <span class="keywordtype">double</span>* in1 = in[0][0];
00149         <span class="keywordtype">double</span>* in2 = in[1][0];
00150         <a class="code" href="arrays_8h.html#a3">array3D</a> invD = EP-&gt;<a class="code" href="structelastic_plan__t.html#o0">M</a>-&gt;<a class="code" href="structelastic_matrix__t.html#o0">data</a>;
00151         fftw_complex *fftIn1, *fftIn2;
00152         <span class="keywordtype">double</span> maxX1, maxX2;
00153         maxX1 = maxX2 = 0;
00154         
00155         fftIn1 = (fftw_complex*) fftw_malloc(<span class="keyword">sizeof</span>(fftw_complex) * m12);
00156         fftIn2 = (fftw_complex*) fftw_malloc(<span class="keyword">sizeof</span>(fftw_complex) * m12);
00157         
00158         <span class="comment">/* fftIn1=fft2(in1) */</span>
00159         <span class="keywordflow">for</span> (k1=0; k1&lt;m12; k1++) {
00160                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][0] = (-1)*in1[k1];
00161                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][1] = 0;
00162         }
00163         fftw_execute(EP-&gt;<a class="code" href="structelastic_plan__t.html#o1">pForw</a>); 
00164         <span class="keywordflow">for</span> (k1=0; k1&lt;m12; k1++){
00165                 fftIn1[k1][0] = EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>[k1][0];
00166                 fftIn1[k1][1] = EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>[k1][1];
00167         }       
00168         
00169         <span class="comment">/* fftIn2=fft2(in2) */</span>
00170         <span class="keywordflow">for</span> (k1=0; k1&lt;m12; k1++) {
00171                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][0] = (-1)*in2[k1];
00172                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][1] = 0;
00173         } 
00174         fftw_execute(EP-&gt;<a class="code" href="structelastic_plan__t.html#o1">pForw</a>); 
00175         <span class="keywordflow">for</span> (k1=0; k1&lt;m12; k1++){
00176                 fftIn2[k1][0] = EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>[k1][0];
00177                 fftIn2[k1][1] = EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>[k1][1];
00178         }
00179         
00180 
00181         <span class="comment">/* calculate du1 */</span>
00182          <span class="comment">/* du1 = invD11.*fft2(in1) + invD12.*fft2(in2) */</span>
00183         <span class="keywordflow">for</span> (k1=0; k1&lt;m12; k1++){
00184                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][0] = invD[0][0][k1] * fftIn1[k1][0] + invD[1][0][k1] * fftIn2[k1][0]; <span class="comment">/* real */</span>
00185                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][1] = invD[0][0][k1] * fftIn1[k1][1] + invD[1][0][k1] * fftIn2[k1][1]; <span class="comment">/* imag */</span>
00186         }
00187         fftw_execute(EP-&gt;<a class="code" href="structelastic_plan__t.html#o2">pBackw</a>); 
00188         <span class="keywordflow">for</span> (k1=0; k1&lt;m12; k1++){
00189                 out[0][0][k1] = EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>[k1][0];
00190                 maxX1 = maxAbs(maxX1,out[0][0][k1]);
00191         }
00192         
00193         <span class="comment">/* calculate du2 */</span>
00194         <span class="comment">/* du2 = invD12.*fft2(in1) + invD22.*fft2(in2) */</span>
00195         <span class="keywordflow">for</span> (k1=0; k1&lt;m12; k1++){
00196                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][0] = invD[1][0][k1] * fftIn1[k1][0] + invD[2][0][k1] * fftIn2[k1][0]; <span class="comment">/* real */</span>
00197                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][1] = invD[1][0][k1] * fftIn1[k1][1] + invD[2][0][k1] * fftIn2[k1][1]; <span class="comment">/* imag */</span>
00198         }
00199         fftw_execute(EP-&gt;<a class="code" href="structelastic_plan__t.html#o2">pBackw</a>); 
00200         <span class="keywordflow">for</span> (k1=0; k1&lt;m12; k1++){
00201                 out[1][0][k1] = EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>[k1][0];
00202                 maxX2 = maxAbs(maxX2,out[1][0][k1]);
00203         }
00204 
00205         fftw_free(fftIn1);
00206         fftw_free(fftIn2);
00207         
00208         printf(<span class="stringliteral">"\tmax(abs(dU1)) = %f, max(abs(dU2)) = %f\n"</span>,maxX1,maxX2); 
00209 }
00210 <span class="comment">/*==============================================</span>
00211 <span class="comment">/* 3d-Fall</span>
00212 <span class="comment">/*==============================================</span>
00213 <span class="comment">/* --------------------------------------------------------------------- */</span>
00214 <span class="keywordtype">void</span> initElasticMatrix3D(size_t m1,
00215                                                  size_t m2,
00216                                                  size_t m3,
00217                                                  <span class="keywordtype">double</span> mu, 
00218                                                  <span class="keywordtype">double</span> lambda,
00219                                                  <span class="keywordtype">double</span> h1,
00220                                                  <span class="keywordtype">double</span> h2,
00221                                                  <span class="keywordtype">double</span> h3,
00222                                                  boundary_t bc,
00223                                                  <a class="code" href="structelastic_matrix__t.html">elasticMatrix</a>* pMatrix){
00224         
00225         <span class="keywordtype">int</span> k1,k2,k3;
00226         <span class="keywordtype">double</span> ak1,ak2,ak3,ck1,ck2,ck3,sk1,sk2,sk3;
00227         <span class="keywordtype">double</span> d11,d12,d13,d22,d23,d33,detD;
00228         
00229         <span class="keywordtype">double</span> m2lp4m = -2*(lambda + 3*mu);
00230         <span class="keywordtype">double</span> lp2m   = lambda + 2 * mu;
00231         <span class="keywordtype">double</span> lpm    = lambda + mu;
00232         
00233         <a class="code" href="structelastic_matrix__t.html">elasticMatrix</a> M;
00234         M       = (<a class="code" href="structelastic_matrix__t.html">elasticMatrix</a>) malloc(<span class="keyword">sizeof</span>(<a class="code" href="structelastic_matrix__t.html">elasticMatrix_t</a>));
00236 <span class="preprocessor">        #if 0</span>
00237 <span class="preprocessor"></span>        M-&gt;<a class="code" href="structelastic_matrix__t.html#o0">data</a> = createArray3D(3,m1,m2);
00238 <span class="preprocessor">        #endif</span>
00239 <span class="preprocessor"></span>        M-&gt;<a class="code" href="structelastic_matrix__t.html#o0">data</a> = createTreeStructure4D(4,m1,m2,m3, (array2D) calloc(4*m3*m2*m1,<span class="keyword">sizeof</span>(array_t)) );
00240         <span class="comment">/* \SB */</span>
00241         
00242         M-&gt;<a class="code" href="structelastic_matrix__t.html#o1">len</a>  = m1*m2*m3*4;   
00243         
00244         <a class="code" href="arrays_8h.html#a4">array4D</a> invD = M-&gt;<a class="code" href="structelastic_matrix__t.html#o0">data</a>;
00245         
00246         <span class="keywordflow">if</span> (bc == PERIODIC){
00247                 <span class="comment">/* create inverse Matrix -------------------------------------------------- */</span>
00248                 <span class="keywordflow">for</span> (k1=0;k1&lt;m1;k1++){
00249                         <span class="keywordflow">for</span> (k2=0;k2&lt;m2;k2++){
00250                                 <span class="keywordflow">for</span> (k3=0;k3&lt;m3;k3++){
00251                                         ak1 = 2*<a class="code" href="defs_8h.html#a0">PI</a>*k1/m1;
00252                                         ak2 = 2*<a class="code" href="defs_8h.html#a0">PI</a>*k2/m2;
00253                                         ak3 = 2*<a class="code" href="defs_8h.html#a0">PI</a>*k3/m3;
00254                                         
00255                                         ck1 = 2*cos(ak1);
00256                                         ck2 = 2*cos(ak2);
00257                                         ck3 = 2*cos(ak3);
00258                                         
00259                                         sk1 = sin(ak1);
00260                                         sk2 = sin(ak2);
00261                                         sk3 = sin(ak3);
00262                                 
00263                                         d11 = (m2lp4m + lp2m*ck1 + mu*(ck2 + ck3))/(h1*h1); 
00264                                         d12 = -lpm * sk1 * sk2/(h1*h2); 
00265                                         d13 = -lpm * sk1 * sk3/(h1*h3);                  
00266                                         d22 = (m2lp4m + mu*(ck1 + ck2) + lp2m*ck3)/(h2*h2); 
00267                                         d23 = -lpm * sk2 * sk3/(h2*h3);
00268                                         d33 = (m2lp4m + mu*(ck1 + ck3) + lp2m*ck2)/(h3*h3);
00269                                 
00270                                         <span class="comment">/* calculate determinant -------------------------------------------- */</span>
00271                                         detD =  d11*d22*d33 - d11*d23*d23 - d12*d12*d33 + d12*d13*d23 + d12*d13*d23 - d13*d13*d22;
00272                                 
00273                                         <span class="keywordflow">if</span> (fabs(detD) &lt; 1e-15){
00274                                                 <span class="comment">/* numerically zero */</span>
00275                                                 <span class="comment">/* invD[0] = D11+</span>
00276 <span class="comment">                                                   invD[1] = D12+</span>
00277 <span class="comment">                                                   invD[2] = D13+</span>
00278 <span class="comment">                                                   invD[3] = D22+</span>
00279 <span class="comment">                                                   invD[4] = D23+</span>
00280 <span class="comment">                                                   invD[5] = D33+</span>
00281 <span class="comment">                                                */</span>
00282                                                 invD[0][k1][k2][k3] = 0; invD[1][k1][k2][k3] = 0; invD[2][k1][k2][k3] = 0;
00283                                                 invD[3][k1][k2][k3] = 0; invD[4][k1][k2][k3] = 0; invD[5][k1][k2][k3] = 0;
00284                                         } 
00285                                         <span class="keywordflow">else</span>{
00286                                                 invD[0][k1][k2][k3] = (d22*d33 - d23*d23)/detD;
00287                                                 invD[1][k1][k2][k3] = (d13*d23 - d12*d33)/detD;
00288                                                 invD[2][k1][k2][k3] = (d12*d23 - d13*d22)/detD;
00289                                                 invD[3][k1][k2][k3] = (d11*d33 - d13*d13)/detD; 
00290                                                 invD[4][k1][k2][k3] = (d12*d13 - d11*d23)/detD; 
00291                                                 invD[5][k1][k2][k3] = (d11*d22 - d12*d12)/detD;
00292                                         } 
00293                                 }       
00294                         }
00295                 }
00296                 
00297                 *(pMatrix) = M;
00298         }
00299         <span class="keywordflow">else</span> {
00300                 printf(<span class="stringliteral">"Elastic solver currently only implemented for periodic boundary conditions!"</span>);
00301                 *(pMatrix) = NULL;
00302         }
00303 };
00304 
00305 
00306 <span class="comment">/* --------------------------------------------------------------------- */</span>
00307 <span class="keywordtype">void</span> initElasticPlan3D(size_t m1, 
00308                                            size_t m2,
00309                                            size_t m3,
00310                                            <span class="keywordtype">double</span> alpha, 
00311                                            <span class="keywordtype">double</span> mu,
00312                                            <span class="keywordtype">double</span> lambda,
00313                                            <span class="keywordtype">double</span> h1,
00314                                            <span class="keywordtype">double</span> h2,
00315                                            <span class="keywordtype">double</span> h3,
00316                                            boundary_t bc,
00317                                            <a class="code" href="structelastic_plan__t.html">elasticPlan</a>* pPlan)
00318 {
00319         
00320         <a class="code" href="structelastic_plan__t.html">elasticPlan</a> EP;
00321         EP = (<a class="code" href="structelastic_plan__t.html">elasticPlan</a>) malloc(<span class="keyword">sizeof</span>(<a class="code" href="structelastic_plan__t.html">elasticPlan_t</a>));
00322         
00323         initElasticMatrix3D(m1,m2, m3, mu, lambda, h1, h2, h3, bc, &amp;(EP-&gt;<a class="code" href="structelastic_plan__t.html#o0">M</a>));
00324 
00325         EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>     = (fftw_complex*) fftw_malloc(<span class="keyword">sizeof</span>(fftw_complex) * m1 * m2 * m3);
00326         EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>    = (fftw_complex*) fftw_malloc(<span class="keyword">sizeof</span>(fftw_complex) * m1 * m2 * m3);
00327         EP-&gt;<a class="code" href="structelastic_plan__t.html#o1">pForw</a>  = fftw_plan_dft_3d(m1, m2, m3, EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>, EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>, FFTW_FORWARD,  FFTW_MEASURE);
00328         EP-&gt;<a class="code" href="structelastic_plan__t.html#o2">pBackw</a> = fftw_plan_dft_3d(m1, m2, m3, EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>, EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>, FFTW_BACKWARD, FFTW_MEASURE);
00329 
00330         EP-&gt;<a class="code" href="structelastic_plan__t.html#o5">alpha</a>  = alpha;
00331         EP-&gt;<a class="code" href="structelastic_plan__t.html#o6">mu</a>     = mu;
00332         EP-&gt;<a class="code" href="structelastic_plan__t.html#o7">lambda</a> = lambda;
00333         EP-&gt;<a class="code" href="structelastic_plan__t.html#o8">dim</a>    = 3;
00334         EP-&gt;<a class="code" href="structelastic_plan__t.html#o12">m1</a>     = m1;
00335         EP-&gt;<a class="code" href="structelastic_plan__t.html#o13">m2</a>     = m2;
00336         EP-&gt;<a class="code" href="structelastic_plan__t.html#o14">m3</a>     = m3;
00337         EP-&gt;<a class="code" href="structelastic_plan__t.html#o9">h1</a>     = h1;
00338         EP-&gt;<a class="code" href="structelastic_plan__t.html#o10">h2</a>     = h2;
00339         EP-&gt;<a class="code" href="structelastic_plan__t.html#o11">h3</a>     = h3;
00340         EP-&gt;<a class="code" href="structelastic_plan__t.html#o15">bc</a>     = bc;
00341         
00342         *(pPlan) = EP;
00343 }                          
00344 
00345 <span class="comment">/* --------------------------------------------------------------------- */</span>
00346 <span class="keywordtype">void</span> solveElastic3D(<a class="code" href="structelastic_plan__t.html">elasticPlan</a> EP, 
00347                                         <span class="keywordtype">double</span>*** in, 
00348                                         <span class="keywordtype">double</span>*** out)
00349 {
00350         <span class="keywordtype">int</span> k1, k2, k3; 
00351         <span class="keywordtype">int</span> m1 = EP-&gt;<a class="code" href="structelastic_plan__t.html#o12">m1</a>;
00352         <span class="keywordtype">int</span> m2 = EP-&gt;<a class="code" href="structelastic_plan__t.html#o13">m2</a>;
00353         <span class="keywordtype">int</span> m3 = EP-&gt;<a class="code" href="structelastic_plan__t.html#o14">m3</a>;
00354         <span class="keywordtype">int</span> m123 = m1*m2*m3;
00355         <span class="keywordtype">double</span>* in1 = in[0][0];
00356         <span class="keywordtype">double</span>* in2 = in[1][0];
00357         <span class="keywordtype">double</span>* in3 = in[1][0];
00358         <a class="code" href="arrays_8h.html#a4">array4D</a> invD = EP-&gt;<a class="code" href="structelastic_plan__t.html#o0">M</a>-&gt;<a class="code" href="structelastic_matrix__t.html#o0">data</a>;
00359         fftw_complex *fftIn1, *fftIn2, *fftIn3;
00360         <span class="keywordtype">double</span> maxX1, maxX2, maxX3;
00361         maxX1 = maxX2 = maxX3 = 0;
00362         
00363         <span class="comment">// =======================================================</span>
00364         <span class="comment">// Verstehe ich nicht :-(</span>
00365         <span class="comment">// =======================================================</span>
00366         fftIn1 = (fftw_complex*) fftw_malloc(<span class="keyword">sizeof</span>(fftw_complex) * m123);
00367         fftIn2 = (fftw_complex*) fftw_malloc(<span class="keyword">sizeof</span>(fftw_complex) * m123);
00368         fftIn3 = (fftw_complex*) fftw_malloc(<span class="keyword">sizeof</span>(fftw_complex) * m123);
00369         
00371         <span class="comment">/* hier werden die Daten von der übergeordneten Struktur</span>
00372 <span class="comment">                in den FFTW-Transformations-Kasten kopiert */</span>
00373         <span class="keywordflow">for</span> (k1=0; k1&lt;m123; k1++) {
00374                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][0] = (-1)*in1[k1];<span class="comment">/* Realteil */</span>
00375                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][1] = 0; <span class="comment">/* Imaginaerteil */</span>
00376         }
00377         fftw_execute(EP-&gt;<a class="code" href="structelastic_plan__t.html#o1">pForw</a>); <span class="comment">/* fuehre FFT aus */</span>
00378         <span class="comment">/* nun kopiere die Daten von der FFTW-Box in die eigentliche</span>
00379 <span class="comment">                Datenstruktur */</span>
00380         <span class="keywordflow">for</span> (k1=0; k1&lt;m123; k1++){
00381                 fftIn1[k1][0] = EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>[k1][0]; <span class="comment">/* real */</span>
00382                 fftIn1[k1][1] = EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>[k1][1]; <span class="comment">/* imag */</span>
00383         }       
00384         
00385         <span class="comment">/* fftIn2=fft3(in2) */</span>
00386         <span class="keywordflow">for</span> (k1=0; k1&lt;m123; k1++) {
00387                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][0] = (-1)*in2[k1]; <span class="comment">/* real */</span>
00388                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][1] = 0; <span class="comment">/* imag */</span>
00389         } 
00390         fftw_execute(EP-&gt;<a class="code" href="structelastic_plan__t.html#o1">pForw</a>); <span class="comment">/* ausfuehren FFT */</span>
00391         <span class="keywordflow">for</span> (k1=0; k1&lt;m123; k1++){
00392                 fftIn2[k1][0] = EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>[k1][0]; <span class="comment">/* real */</span>
00393                 fftIn2[k1][1] = EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>[k1][1]; <span class="comment">/* imag */</span>
00394         }
00395         
00396         
00397         <span class="comment">/* und fuer in3 ... */</span>
00398                 <span class="keywordflow">for</span> (k1=0; k1&lt;m123; k1++) {
00399                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][0] = (-1)*in3[k1]; <span class="comment">/* real */</span>
00400                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][1] = 0; <span class="comment">/* imag */</span>
00401         } 
00402         fftw_execute(EP-&gt;<a class="code" href="structelastic_plan__t.html#o1">pForw</a>); <span class="comment">/* ausfuehren FFT */</span>
00403         <span class="keywordflow">for</span> (k1=0; k1&lt;m123; k1++){
00404                 fftIn2[k1][0] = EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>[k1][0]; <span class="comment">/* real */</span>
00405                 fftIn2[k1][1] = EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>[k1][1]; <span class="comment">/* imag */</span>
00406         }
00407         
00408 <span class="comment">// =======================================================</span>
00409 <span class="comment">// Ende "Verstehe ich nicht :-("</span>
00410 <span class="comment">// =======================================================      </span>
00411 
00412         <span class="comment">/* calculate du1 */</span>
00413          <span class="comment">/* du1 = invD11.*fft3(in1) + invD12.*fft3(in2) + invD13.*fft3(in3) */</span>
00414         <span class="keywordflow">for</span> (k1=0; k1&lt;m123; k1++){
00415                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][0] = invD[0][0][0][k1] * fftIn1[k1][0] + invD[1][0][0][k1] * fftIn2[k1][0] + invD[2][0][0][k1] * fftIn3[k1][0]; <span class="comment">/* real */</span>
00416                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][1] = invD[0][0][0][k1] * fftIn1[k1][1] + invD[1][0][0][k1] * fftIn2[k1][1] + invD[2][0][0][k1] * fftIn3[k1][1]; <span class="comment">/* imag */</span>
00417         }
00418         fftw_execute(EP-&gt;<a class="code" href="structelastic_plan__t.html#o2">pBackw</a>); 
00419         <span class="keywordflow">for</span> (k1=0; k1&lt;m123; k1++){
00420                 out[0][0][k1] = EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>[k1][0];
00421                 maxX1 = maxAbs(maxX1,out[0][0][k1]);
00422         }
00423         
00424         <span class="comment">/* calculate du2 */</span>
00425         <span class="comment">/* du2 = invD12.*fft3(in1) + invD22.*fft3(in2) + invD23.*fft3(in3) */</span>
00426         <span class="keywordflow">for</span> (k1=0; k1&lt;m123; k1++){
00427                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][0] = invD[1][0][0][k1] * fftIn1[k1][0] + invD[3][0][0][k1] * fftIn2[k1][0] + invD[4][0][0][k1] * fftIn3[k1][0]; <span class="comment">/* real */</span>
00428                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][1] = invD[1][0][0][k1] * fftIn1[k1][1] + invD[3][0][0][k1] * fftIn2[k1][1] + invD[4][0][0][k1] * fftIn3[k1][1]; <span class="comment">/* imag */</span>
00429         }
00430         fftw_execute(EP-&gt;<a class="code" href="structelastic_plan__t.html#o2">pBackw</a>); 
00431         <span class="keywordflow">for</span> (k1=0; k1&lt;m123; k1++){
00432                 out[1][0][k1] = EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>[k1][0];
00433                 maxX2 = maxAbs(maxX2,out[1][0][k1]);
00434         }
00435 
00436         <span class="comment">/* calculate du3 */</span>
00437         <span class="comment">/* du3 = invD13.*fft3(in1) + invD23.*fft3(in2) + invD33.*fft3(in3) */</span>
00438         <span class="keywordflow">for</span> (k1=0; k1&lt;m123; k1++){
00439                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][0] = invD[2][0][0][k1] * fftIn1[k1][0] + invD[4][0][0][k1] * fftIn2[k1][0] + invD[5][0][0][k1] * fftIn3[k1][0]; <span class="comment">/* real */</span>
00440                 EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>[k1][1] = invD[2][0][0][k1] * fftIn1[k1][1] + invD[4][0][0][k1] * fftIn2[k1][1] + invD[5][0][0][k1] * fftIn3[k1][1]; <span class="comment">/* imag */</span>
00441         }
00442         fftw_execute(EP-&gt;<a class="code" href="structelastic_plan__t.html#o2">pBackw</a>); 
00443         <span class="keywordflow">for</span> (k1=0; k1&lt;m123; k1++){
00444                 out[2][0][k1] = EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>[k1][0];
00445                 maxX3 = maxAbs(maxX3,out[2][0][k1]);
00446         }
00447         
00448         fftw_free(fftIn1);
00449         fftw_free(fftIn2);
00450         fftw_free(fftIn3);
00451         
00452         printf(<span class="stringliteral">"\tmax(abs(dU1)) = %f, max(abs(dU2)) = %f\n, max(abs(dU2)) = %f\n"</span>,maxX1,maxX2,maxX3); 
00453 }
00454 <span class="comment">/*==============================================</span>
00455 <span class="comment">/* Ende der 3d-Fall</span>
00456 <span class="comment">/*==============================================</span>
00457 <span class="comment"></span>
00458 <span class="comment">/* --------------------------------------------------------------------- */</span>
00459 <span class="keywordtype">void</span> deleteElasticMatrix(<a class="code" href="structelastic_matrix__t.html">elasticMatrix</a> A)
00460 {
00461         <span class="keywordflow">if</span> (A != NULL){
00462                 deleteArray3D(A-&gt;<a class="code" href="structelastic_matrix__t.html#o0">data</a>);
00463                 free(A);
00464         }
00465 }
00466 
00467 
00468 <span class="comment">/* --------------------------------------------------------------------- */</span>
00469 <span class="keywordtype">void</span> deleteElasticPlan(<a class="code" href="structelastic_plan__t.html">elasticPlan</a> EP)
00470 {
00471         <span class="keywordflow">if</span> (EP != NULL){
00472                 deleteElasticMatrix(EP-&gt;<a class="code" href="structelastic_plan__t.html#o0">M</a>);
00473                 fftw_destroy_plan(EP-&gt;<a class="code" href="structelastic_plan__t.html#o1">pForw</a>);
00474                 fftw_destroy_plan(EP-&gt;<a class="code" href="structelastic_plan__t.html#o2">pBackw</a>);
00475                 fftw_free(EP-&gt;<a class="code" href="structelastic_plan__t.html#o3">in</a>);
00476                 fftw_free(EP-&gt;<a class="code" href="structelastic_plan__t.html#o4">out</a>);
00477                 free(EP);
00478         }
00479 }
00480 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jan 10 08:16:41 2006 for flirt by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.1 </small></address>
</body>
</html>
