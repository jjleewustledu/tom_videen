<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>flirt: UpdateRule.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<div class="nav">
<a class="el" href="dir_000000.html">home</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">ens</a>&nbsp;/&nbsp;<a class="el" href="dir_000002.html">flirtproj</a>&nbsp;/&nbsp;<a class="el" href="dir_000003.html">flirt++</a></div>
<h1>UpdateRule.cc</h1><div class="fragment"><pre class="fragment">00001 <span class="preprocessor">#include "<a class="code" href="_array_8h.html">Array.h</a>"</span>
00002 <span class="preprocessor">#include "DistanceMeasure.h"</span>
00003 <span class="preprocessor">#include "Smoother.h"</span>
00004 <span class="preprocessor">#include "Image.h"</span>
00005 <span class="preprocessor">#include "<a class="code" href="_displacement_8h.html">Displacement.h</a>"</span>
00006 <span class="preprocessor">#include "Optimizer.h"</span>
00007 <span class="preprocessor">#include "UpdateRule.h"</span>
00008 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00009 
00010 <span class="keyword">namespace </span>flirt {
00011 
00012 <span class="comment">// ---------------------------------------------------------------------</span>
00013 <span class="comment">//</span>
00014 <span class="comment">// UpdateRule</span>
00015 <span class="comment">//</span>
00016 <span class="comment">// ---------------------------------------------------------------------</span>
00017 
<a name="l00018"></a><a class="code" href="classflirt_1_1_update_rule.html#a0">00018</a> UpdateRule ::  UpdateRule(<a class="code" href="classflirt_1_1_distance_measure.html">DistanceMeasure</a>&amp; _dist, 
00019                           <a class="code" href="classflirt_1_1_smoother.html">Smoother</a>&amp;        _smoother,
00020                           <a class="code" href="classflirt_1_1_optimizer.html">Optimizer</a>&amp;       _opti) 
00021   : dist(_dist), smoother(_smoother), opti(_opti) {
00022   <span class="comment">//printf("UpdateRule (%p) :: Constructor\n", this);</span>
00023 };
00024    
<a name="l00025"></a><a class="code" href="classflirt_1_1_update_rule.html#a2">00025</a> <span class="keywordtype">void</span> UpdateRule :: updateDisplacement(<a class="code" href="classflirt_1_1_displacement.html">Displacement</a>&amp; u) {
00026   <a class="code" href="classflirt_1_1_array.html">Array</a>&amp; du = opti.<a class="code" href="classflirt_1_1_optimizer.html#a1">getUpdate</a>();
00027   <span class="keywordflow">if</span> (haveSameSize(du,u)) {
00028     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;u.getNumberOfElements(); ++i)
00029       u.<a class="code" href="classflirt_1_1_array.html#a13">getData</a>()[i] = du.<a class="code" href="classflirt_1_1_array.html#a13">getData</a>()[i];
00030   } <span class="keywordflow">else</span> {
00031     printf(<span class="stringliteral">"%s %d (Build %s %s) -- "</span>,__FILE__,__LINE__,__DATE__,__TIME__);
00032     printf(<span class="stringliteral">" UpdateRule :: updateDisplacement(u) : "</span>
00033            <span class="stringliteral">"Dimensions of u  does not match dimensions of the update\n"</span>
00034            <span class="stringliteral">"du=opti.getUpdate()!\n"</span>); 
00035     printf(<span class="stringliteral">"Dimensions u:\n"</span>);
00036     u.<a class="code" href="classflirt_1_1_array.html#a18">printDimensions</a>();
00037     printf(<span class="stringliteral">"Dimensions du:\n"</span>);
00038     u.<a class="code" href="classflirt_1_1_array.html#a18">printDimensions</a>();
00039     
00040     printf(<span class="stringliteral">"Exiting on error\n."</span>);
00041     exit(-1);
00042   };
00043 }; 
00044 
00045 <span class="comment">// ---------------------------------------------------------------------</span>
00046 <span class="comment">//</span>
00047 <span class="comment">// LineSearch</span>
00048 <span class="comment">//</span>
00049 <span class="comment">// ---------------------------------------------------------------------</span>
00050 
<a name="l00051"></a><a class="code" href="classflirt_1_1_line_search.html#a0">00051</a> LineSearch ::  LineSearch( <a class="code" href="classflirt_1_1_distance_measure.html">DistanceMeasure</a>&amp; dist, 
00052                            <a class="code" href="classflirt_1_1_smoother.html">Smoother</a>&amp;        smoother,
00053                            <a class="code" href="classflirt_1_1_optimizer.html">Optimizer</a>&amp;       opti,
00054                            <a class="code" href="classflirt_1_1_transformable_image.html">TransformableImage</a>&amp; TI,
00055                            <span class="keyword">const</span> <a class="code" href="classflirt_1_1_displacement2_d.html">Displacement2D</a>&amp; u) 
00056   : <a class="code" href="classflirt_1_1_update_rule.html">UpdateRule</a>(dist,smoother,opti), T(TI), isFirstUpdate(1), uold( u.getDimensions(), u.getNumberOfDimensions()) {
00057   <span class="comment">//printf("Constructor LineSearch(DistanceMeasure, Smoother, Optimizer,"</span>
00058   <span class="comment">//     " TransformableImage2D, Displacement2D\n\n");</span>
00059 };
00060 
<a name="l00061"></a><a class="code" href="classflirt_1_1_line_search.html#a1">00061</a> <span class="keywordtype">void</span> LineSearch :: updateDisplacement(<a class="code" href="classflirt_1_1_displacement.html">Displacement</a>&amp; u) {
00062 
00063   <a class="code" href="classflirt_1_1_array.html">Array</a>&amp; du = opti.<a class="code" href="classflirt_1_1_optimizer.html#a1">getUpdate</a>();
00064  
00065   <span class="keywordflow">if</span> (!haveSameSize(du,u)) {
00066     printf(<span class="stringliteral">"%s %d (bulid %s %s) -- "</span>
00067            <span class="stringliteral">"update and u have different dimensions!\n"</span>,
00068            __FILE__,__LINE__,__DATE__,__LINE__);
00069   };  
00070  
00071   <span class="keywordflow">if</span> (isFirstUpdate) {
00072     isFirstUpdate = 0;
00073   };
00074 
00075 
00076   <span class="keywordtype">double</span> fold    = dist.<a class="code" href="classflirt_1_1_distance_measure.html#a4">getValue</a>();<span class="comment">// + smoother.getValue();  </span>
00077   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;u.getNumberOfElements(); ++i) {
00078     uold.<a class="code" href="classflirt_1_1_array.html#a13">getData</a>()[i] = u.<a class="code" href="classflirt_1_1_array.html#a13">getData</a>()[i];
00079   }
00080 
00081   <span class="keywordtype">double</span> minNormDx = 1e-15;
00082 
00083   <span class="keywordtype">double</span> lambda = 1;
00084   <span class="keywordtype">double</span> fnew;
00085   <span class="keywordtype">double</span> normdu = normInf(du.<a class="code" href="classflirt_1_1_array.html#a13">getData</a>(),du.<a class="code" href="classflirt_1_1_array.html#a15">getNumberOfElements</a>());
00086   <span class="keywordtype">int</span> failure = 0;
00087 
00088   <span class="keywordflow">do</span> {
00089     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;u.getNumberOfElements(); ++i) {
00090       u.<a class="code" href="classflirt_1_1_array.html#a13">getData</a>()[i] = uold.<a class="code" href="classflirt_1_1_array.html#a13">getData</a>()[i] + lambda * du.<a class="code" href="classflirt_1_1_array.html#a13">getData</a>()[i];
00091     }
00092     
00093     T.<a class="code" href="classflirt_1_1_transformable_image.html#a2">transform</a>(u);
00094     dist.<a class="code" href="classflirt_1_1_distance_measure.html#a2">eval</a>();
00095     smoother.<a class="code" href="classflirt_1_1_smoother.html#a2">eval</a>(u);
00096     
00097     fnew = dist.<a class="code" href="classflirt_1_1_distance_measure.html#a4">getValue</a>();<span class="comment">// + smoother.getValue();  </span>
00098     
00099     <span class="comment">//printf("fold = %g, fnew = %g (lambda=%g)\n",fold,fnew,lambda);</span>
00100     
00101     <span class="keywordflow">if</span> (fabs(lambda)*normdu &lt; minNormDx) {
00102       failure = 1;
00103     }      
00104     
00105     lambda *= 0.5;
00106     
00107   } <span class="keywordflow">while</span> ((fnew &gt; fold) &amp;&amp; (!failure));
00108 
00109   <span class="keywordflow">if</span> (failure) {
00110     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;u.getNumberOfElements(); ++i) {
00111       u.getData()[i] = uold.<a class="code" href="classflirt_1_1_array.html#a13">getData</a>()[i];
00112     }
00113     printf(<span class="stringliteral">"%s %d (Build %s %s) -- "</span>,__FILE__,__LINE__,__DATE__,__TIME__);
00114     printf(<span class="stringliteral">"updateDisplacement(u) : "</span>
00115            <span class="stringliteral">"Linesearch failed! Omitting update.\n"</span>); 
00116   }
00117 
00118 }
00119 
00120 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jan 10 08:16:41 2006 for flirt by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.1 </small></address>
</body>
</html>
