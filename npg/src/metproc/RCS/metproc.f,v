head	2.32;
access;
symbols;
locks; strict;
comment	@c @;


2.32
date	2010.12.30.20.52.42;	author tom;	state Exp;
branches;
next	2.31;

2.31
date	2008.09.04.14.59.31;	author tom;	state Exp;
branches;
next	2.29;

2.29
date	2007.08.15.18.50.17;	author tom;	state Exp;
branches;
next	2.28;

2.28
date	2007.03.21.21.17.56;	author tom;	state Exp;
branches;
next	2.27;

2.27
date	2005.08.08.16.27.56;	author tom;	state Exp;
branches;
next	2.26;

2.26
date	2004.11.03.15.31.15;	author tom;	state Exp;
branches;
next	2.25;

2.25
date	2004.11.03.14.20.17;	author tom;	state Exp;
branches;
next	2.24;

2.24
date	2004.11.02.16.37.24;	author tom;	state Exp;
branches;
next	2.23;

2.23
date	2004.11.02.16.35.51;	author tom;	state Exp;
branches;
next	2.22;

2.22
date	2004.11.01.20.02.27;	author tom;	state Exp;
branches;
next	2.21;

2.21
date	2004.07.08.14.41.37;	author tom;	state Exp;
branches;
next	2.20;

2.20
date	2004.02.17.14.13.40;	author tom;	state Exp;
branches;
next	2.18;

2.18
date	2002.12.02.17.08.36;	author tom;	state Exp;
branches;
next	2.17;

2.17
date	2001.06.01.18.48.41;	author tom;	state Exp;
branches;
next	2.16;

2.16
date	99.12.16.15.27.47;	author tom;	state Exp;
branches;
next	2.15;

2.15
date	99.12.15.22.49.03;	author tom;	state Exp;
branches;
next	2.14;

2.14
date	99.12.15.22.41.18;	author tom;	state Exp;
branches;
next	2.13;

2.13
date	98.07.15.16.52.25;	author tom;	state Exp;
branches;
next	2.12;

2.12
date	97.03.19.20.20.07;	author tom;	state Exp;
branches;
next	2.11;

2.11
date	97.03.10.17.15.28;	author tom;	state Exp;
branches;
next	2.10;

2.10
date	97.03.10.16.18.32;	author tom;	state Exp;
branches;
next	2.9;

2.9
date	97.01.20.19.00.46;	author tom;	state Exp;
branches;
next	2.8;

2.8
date	96.10.29.22.19.37;	author tom;	state Exp;
branches;
next	2.7;

2.7
date	96.10.29.19.27.43;	author tom;	state Exp;
branches;
next	2.6;

2.6
date	96.10.16.16.52.28;	author tom;	state Exp;
branches;
next	2.5;

2.5
date	96.10.14.20.55.02;	author tom;	state Exp;
branches;
next	2.4;

2.4
date	95.12.20.04.33.22;	author tom;	state Exp;
branches;
next	2.3;

2.3
date	93.10.15.17.51.17;	author tom;	state Exp;
branches;
next	2.2;

2.2
date	93.10.15.16.33.22;	author tom;	state Exp;
branches;
next	2.1;

2.1
date	93.07.15.20.25.17;	author tom;	state Exp;
branches;
next	2.0;

2.0
date	93.07.12.23.13.24;	author tom;	state Exp;
branches;
next	1.5;

1.5
date	93.07.12.22.48.11;	author tom;	state Exp;
branches;
next	1.4;

1.4
date	92.11.02.16.27.14;	author tom;	state Exp;
branches;
next	1.3;

1.3
date	92.10.19.15.56.10;	author tom;	state Exp;
branches;
next	1.2;

1.2
date	92.10.16.22.32.51;	author tom;	state Exp;
branches;
next	1.1;

1.1
date	92.05.12.21.33.47;	author tom;	state Exp;
branches;
next	;


desc
@Initial Unix version using libpetutil and libpe.
@


2.32
log
@*** empty log message ***
@
text
@c $Log: metproc.f,v $
c Revision 2.31  2008/09/04  14:59:31  tom
c no change
c
c Revision 2.29  2007/08/15  18:50:17  tom
c added getpie_962
c
c Revision 2.28  2007/03/21  21:17:56  tom
c get initials from shell
c eliminate option to reprocess hdr files
c
c Revision 2.27  2005/08/08  16:27:56  tom
c add pie Aug 2005
c
c Revision 2.26  2004/11/03  15:31:15  tom
c prompt with ho1 image
c
c Revision 2.25  2004/11/03  14:20:17  tom
c add getpie_961
c
c Revision 2.24  2004/11/02  16:37:24  tom
c select 961 pies from scandate, software version, acquisition
c
c Revision 2.23  2004/11/02  16:35:51  tom
c *** empty log message ***
c
c Revision 2.22  2004/11/01  20:02:27  tom
c select 961 pies by date, sw_version, and acquisition type
c
c Revision 2.21  2004/07/08  14:41:37  tom
c modify getpie for 961 versions
c
c Revision 2.20  2004/02/17  14:13:40  tom
c Feb 2004
c
c Revision 2.18  2002/12/02  17:08:36  tom
c modifications for gcc
c
c Revision 2.17  2001/06/01  18:48:41  tom
c ntype = 7 for steady-state oxygen
c
c Revision 2.16  1999/12/16  15:27:47  tom
c clean up
c
c Revision 2.15  1999/12/15  22:49:03  tom
c format fix
c
c Revision 2.14  1999/12/15  22:41:18  tom
c y2k and lint clean
c
c Revision 2.13  1998/07/15  16:52:25  tom
c increased array sizes in metproc.inc
c
c Revision 2.12  1997/03/19  20:20:07  tom
c fix getimagetype.c   getimginfo.c
c
c Revision 2.11  1997/03/10  17:15:28  tom
c use firstimgfrm in getimagetype and getimginfo
c
c Revision 2.10  1997/03/10  16:18:32  tom
c read frame 1,2, or 3
c
c Revision 2.9  1997/01/20  19:00:46  tom
c appropriate factor for JMO 3D reconstructed images
c
c Revision 2.8  1996/10/29  22:19:37  tom
c change N2=60 for default
c
c Revision 2.7  1996/10/29  19:27:43  tom
c permit adjustment of calibration using hand-drawn sample
c
c Revision 2.6  1996/10/16  16:52:28  tom
c new libimage
c
c Revision 2.5  1996/10/14  20:55:02  tom
c solaris
c
c Revision 2.4  1995/12/20  04:33:22  tom
c 961 version
c
c Revision 2.3  1993/10/15  17:51:17  tom
c fix bug in get_recon_type
c
c Revision 2.2  1993/10/15  16:33:22  tom
c change tive-activity arrays from 200 to 1000
c
c Revision 2.1  1993/07/15  20:25:17  tom
c Corrected error in pie adjustment for no scatter-correction
c Changed RCSHEADER to ID
c
c Revision 2.0  1993/07/12  23:13:24  tom
c Handles ECAT image format
c
c Revision 1.5  1993/07/12  22:48:11  tom
c Revised to handle ECAT images
c PIE factors are adjusted for the type of reconstruction and acquisition
c
c Revision 1.4  1992/11/02  16:27:14  tom
c *** empty log message ***
c
c Revision 1.3  1992/10/19  15:56:10  tom
c modified RCSHEADER length
c
c Revision 1.2  1992/10/16  22:32:51  tom
c added RCSHEADER
c
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C  Program:      METPROC.FTN
C  Author:       Tom O. Videen
C  Date:         12-Jun-87
C  Intent:
C     This program reads .DTA (blood curve) files, computes metabolic
C     conversion constants, and writes these plus certain parameters
C     from the scan image file (.IMG or .CMG) to a header file (.HDR)
C     associated with the image.  The specific values written to the
C     HDR file are documented in WRITEHDR.
C     These values in the .HDR file are necessary for SPIDERAM to
C     display metabolic images instead of merely PET numbers.
C
C  History:
C     Revision of METEVAL.FTN written by Mark Mintun.
C     Modified 13-Aug-87 by TOV to read write-protected files.
C     Modified 10-Sep-87 by TOV to search for PIE files on DT1 if
C        they are not found on the user's volume when no volume
C        name is specified for the PIE file.
C     Typo in printout from WRITERCD fixed 02-May-88 by TOV.
C     Modified 24-May-88 by TOV to eliminate the need for a redundant
C        blood curve time in processing oxygen (O2UTIL.FTN).
C     Modified 10-Oct-88 by TOV to read PIE file types 4 and 5 (as well
C        as 3) and to check for correct pie based on IMGTYPE
C        (PIEFILE, GETPIE, SAVEPIE)
C        The header from 1 image file must be read before reading a pie file.
C        (METPROC).  IMGTYPE is assigned 1000 or 1020 based on this header
C        and is checked against all other image files during processing.
C        Write version date in output file (WRITERCD).
C        Decay constant of O15 entered correctly as 0.005668 instead of
C        0.005568 as it was entered on 31-Mar-88.
C     Modified 13-Oct-88 by TOV to allow minimum bank pairs to be 0.1 in
C        INTERPIE.
C     Modified 07-Dec-88 by TOV:
C        1) fix minor bugs in PIEFILES, SAVEPIE, and WRITEHDR;
C        2) alter BLOODFLW to write flow vs. PETT COUNTS;
C        3) user may now select maximum flow used to fit curve in BLOODFLW;
C     Modified 27-Mar-89 by TOV:
C        1) user has option of correcting for PETT VI efficiency changes
C           since the specified pie file:
C        2) reads NORM mean counts/bin/minute from scan file header for
C           PETT VI (NORMMEAN)
C        3) reads NORM mean counts/bin/minute and scan date from pie file
C        4) decay corrects pie NORM mean to date of current scan (PIEMEAN)
C           and multiplies all factors by the ratio PIEMEAN/NORMMEAN.
C        5) write PIESLOPE and EFACTOR to HDR file.
C        Altered: METPROC.INC, METPROC, READHEAD, PIEFILE, GETPIE
C           GETFACTR, WRITERCD, INTERPIE, WRITEHDR
C        Add:  PIESCALE
C     Modified 06-Oct-89 by TOV to prevent error it PIEMEAN and PIEDATE
C        do not exist at the end of the pie file; EFACTOR set to 1.0.
C        Altered:  GETPIE, METPROC
C     Modified 25-Jan-91 by TOV to read pie file type 6 and image type 2000.
C     Modified 08-Oct-91 by TOV to correct reading of P8FILTER.
C        Altered:  READHEAD
C
C         Modified for UNIX by TOV 14-Jan to 14-Feb-92:
C            USERIN = 5; USEROUT = 6 (defaults)
C            All files opened internally by name. 
C               PIENAME, DTANAME, RCDNAME, IMGNAME, HDRNAME 
C            Add subroutines: GETARG, GETCWD, ieee2pe
C            Eliminate TERMSET, TCONTROL
C            Changes in:   BLOODFLW, GETIMAGE, GETPIE, INTCONV, METFILE, METPROC
C               READDTA, READHEAD, SAVEPIE, WRITEHDR, WRITERCD, METPROC.INC
C         Modified 12-May-92 by TOV 
C            1) to incorporate libpetutil and libpe.
C                  Changes in:   Makefile, WRITEHDR, READHEAD
C                  Use GETIMG from libpetutil.
C            2) changed remaining FNAME to IMGNAME
C                  Changes in: METFILE, READHDR
C         Modified 28-Oct-92 by TOV
C            1) read dta, DTA, or DAT files (in that order)
C            2) read ECAT pie files (type 7) (getpie.f)
C            3) change extension RCD to rcd
C            4) Default extension for hdrfile is 'hdr' (HDREXT).
C            5) Added HDREXT to call to METFILE (metfile.f)
C         Modified 19-May-93 by TOV
C            1) read ECAT pie files (type 7) (getpie.f)
C            2) user must enter pie file extension (getpie.f)
C         Modified 12-Jul-93 by TO
C            1) read ECAT image files and correct pie according to type of image
C            2) eliminate PIEFILE routine with SAVEPIE option
C            3) eliminate call uppercase(piename)
C         Modified 15-Oct-93 by TOV
C            1) time activity curves of 1000 points ok (metproc.inc)
C            2) fix bug in get_recon_type for scan_month
C
C  Main Subroutines:
C     READDTA  - read blood curve (.DTA) file;
C     METFILE  - open a scan file and set HDRNAME;
C     READTYPE - read selected paramters from scan file header;
C     GETFACTR - get pie slope and partition coefficient;
C     GETPIE   - read PIE files;
C     INTERPIE - get pie slope from interpolation of PIE file values;
C     PIESCALE - compute PETT efficiency factor (EFACTOR) of PIE rel. to scan;
C     O2UTIL   - oxygen utilization model;
C     BLOODFLW - blood flow model;
C     BLOODVOL - blood volume model;
C     INTEGRAT - integrate a function;
C     READHDR  - read scan parameters from an .HDR file;
C     WRITEHDR - create .HDR file;
C     WRITERCD - write record (.RCD) file;
C
C  libpe
C     GTSTRING
C     YESNO
C
C   Sun FORTRAN
C      GETARG
C      GETCWD
C      LNBLNK
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC

      PROGRAM METPROC

      INTEGER*4    DTAFILE   ! file descriptor (lu) of .DTA file
      INTEGER*4    RCDFILE   ! file descriptor (lu) of .RCD file
      INTEGER*4    DISK      ! file descriptor (lu) for image, PIE, and HDR files
      INTEGER*4    NPIES     ! number of PSLOPES/BNKPAIRS
      INTEGER*4    I,L,N
      INTEGER*4    IMGTYPE
      INTEGER*4    N1, N2, LAST
      REAL*4       EFFSCALER, MEANHAND, FITABS, SUM, SLOPE, INTERCEPT, COR
      REAL*4       PSLOPES(10)   ! pie slopes read from PIE file
      REAL*4       BNKPAIRS(10)  ! bank pairs read from PIE file
      REAL*4       EFACTOR
      REAL*4       NORM1,NORM2
      REAL*4       PMEAN
      LOGICAL*1    PEAKUSED   ! true--> user enters peak of Bank Pairs and
C                                       program estimates the mean;
C                               false--> user enters mean Bank Pairs;
      LOGICAL*1    SKIPSCAN   ! true--> do not process the scan;
C                               false--> process the scan;
      LOGICAL*1    IOPTION    ! true--> Pie Slope is computed internally by
C                               reading a PIE file and interpolating peak bank pairs;
      INTEGER*4    ERRCODE
      LOGICAL*1    REPROCES   ! true--> reprocess existing HDR files
C                               false-->get scan parameters from original scan files;

      LOGICAL*1    ADJUST     ! true--> adjust pie factor
      LOGICAL*1    A

      CHARACTER*3   MON
      CHARACTER*3   HDREXT
      CHARACTER*3   FSTATUS   ! file status (OLD or NEW)
      CHARACTER*4   FILELABL  ! 4 characters at the beginning of a DTA file
C               which are used to check agreement with the current program version;
      CHARACTER*8   DATE1, PDATE
      CHARACTER*10  DATE2
      CHARACTER*11  VERSION
      CHARACTER*80  Q
      CHARACTER*256 STR
      CHARACTER*256 RCSHEADER

      CHARACTER*256 HDRNAME   ! name of .HDR file
      CHARACTER*256 DTANAME   ! name of .DTA file
      CHARACTER*256 RCDNAME   ! name of .RCD file

      INCLUDE 'metproc.inc'

      DATA DTAFILE, RCDFILE, DISK /1,2,3/
      DATA USERIN, USEROUT /5,6/
      DATA SCANTYPE(1) /'Oxygen: Mintun Bolus                 '/
      DATA SCANTYPE(2) /'Blood Flow (H2O)                     '/
      DATA SCANTYPE(3) /'Blood Volume (CO)                    '/
      DATA SCANTYPE(4) /'Blood Flow (Butanol)                 '/
      DATA SCANTYPE(5) /'Spiperone                            '/
      DATA SCANTYPE(6) /'Glucose                              '/
      DATA SCANTYPE(7) /'Oxygen: Steady-State                 '/
      DATA SCANTYPE(8) /'Oxygen: Steady-Inhalation Plasma     '/
      DATA SCANTYPE(9) /'Oxygen: Steady-Inhalation Whole-Blood'/
      DATA VERSION /'15-Aug-2007'/
C -------------------------------------------------------------------
      DATA TAUO15    /0.005668/
      DATA TAUO1502  /0.005592/
      DATA TAUO1501  /0.005677/
      DATA TAUO1500  /0.00568033/
      DATA TAUC11    /0.0005668/
      DATA TAUGA68   /0.0001691/
      DATA TAUF18    /0.0010529/
      DATA HOLAMBDA  /0.95/
      DATA BULAMBDA  /0.81/
      DATA BRAINDEN  /1.05/
      DATA BLOODDEN  /1.06/
      DATA SLVRATIO  /0.85/
      DATA RBCFACTOR /0.766/

C  Source for decay constants: first listed halflife for each in
C     Lederer & Shirley, Table of Isotopes, 1978 (7th edition), Wiley.
C     (same no. of significant figures as halflives in this source)
C  Except for O15 where the decay constant was measured using six 20 min
C     decay curves by Mike Welch taken Jan. 1988.  Curves were fit by
C     Tom Videen.
C  Source for HOLAMBDA,BRAINDEN,BLOODDEN,RBCFACTOR:
C     Herscovitch & Raichle (1985) J. Cereb Blood Flow Metabol, 5:65
C  Source for SLVRATIO:
C     Grubb, Raichle, Higgins & Eichling (1978) Annals of Neurology, 4:322
C -------------------------------------------------------------------
C  Initialize constants

      RCSHEADER = "$Id: metproc.f,v 2.31 2008/09/04 14:59:31 tom Exp tom $"
      HDREXT = 'hdr'
      IMGTYPE = 0           ! avoid compiler warning
      EFACTOR = 1.0

      REPROCES = .FALSE.
      ADJUST = .FALSE.
      PIEMEAN = 1.0
      N2 = 60
8100  FORMAT (1X,A,A,A)
      WRITE(USEROUT,*) '>>> METABOLIC PROCESSING  (',VERSION,')'
      WRITE(USEROUT,*) 
      CALL GETENV('PWD',PATH)
      CALL GETARG(1,SUBJECT)
      L = LNBLNK(SUBJECT)
      CALL GETARG(2,STR)
      INITIALS = STR(1:4)
      WRITE(USEROUT,8105) PATH(: LNBLNK(PATH)), SUBJECT, INITIALS
8105  FORMAT('Current Directory = ',A,/,'Subject ID = ',A,/,'Your ID = ',A)
      DO 10 I=1,7
         COUNT(I) = 1
10    CONTINUE

C  Open DTA and RCD files

      DTANAME = SUBJECT(1:L)//'.dta'
      FSTATUS = 'OLD'
      OPEN(DTAFILE,FILE=DTANAME,STATUS='OLD',ERR=15)
      GO TO 30
15    DTANAME = SUBJECT(1:L)//'.DTA'
      OPEN(DTAFILE,FILE=DTANAME,STATUS='OLD',ERR=20)
      GO TO 30
20    DTANAME = SUBJECT(1:L)//'.DAT'
      OPEN(DTAFILE,FILE=DTANAME,STATUS='OLD',ERR=25)
      GO TO 30
25    WRITE(USEROUT,8110) SUBJECT(1:L), SUBJECT(1:L)
      STOP
30    WRITE(USEROUT,8115) DTANAME(: LNBLNK(DTANAME))

8110   FORMAT('Neither blood curve file ',A,'.dta ',A,'.DTA nor ',A,'.DAT exists!')
8115   FORMAT('Reading blood curve from ',A)

      RCDNAME = SUBJECT(1:L)//'.rcd'
      OPEN(RCDFILE,FILE=RCDNAME,ERR=35)
      GO TO 40
35    WRITE(USEROUT,8120) RCDNAME(: LNBLNK(RCDNAME))
      STOP
40    WRITE(USEROUT,8125) RCDNAME(: LNBLNK(RCDNAME))
8120  FORMAT('Cannot open file ',A)
8125  FORMAT('Log of processing will be written to ',A)

C  Obtain initials of USER

C      STR = ' '
C      Q = 'Enter your initials (max=4)'
C      CALL GTSTRING(Q,STR)
C      INITIALS = STR(1:4)

C  Reprocess existing HDR files

C      WRITE(USEROUT,*) 'WARNING:  If you REPROCESS HDR files you must be certain that all'
C      WRITE(USEROUT,*) 'images were processed with the same reconstruction stream.'
C      WRITE(USEROUT,*) 'If they were not, the wrong pie factor may be used.'
C      WRITE(USEROUT,*)
C      Q = 'Reprocess existing HDR files without reading scan files'
C      CALL YESNO(Q,REPROCES)

C  Get default volume and extension

      IF (REPROCES) THEN
         Q = 'Directory path for HDR files'
         STR = PATH(: LNBLNK(PATH))
         CALL GTSTRING(Q,STR)
         PATH = STR(: LNBLNK(PATH))
         EXTENSION = HDREXT
      ELSE
         Q = 'Directory path for scan files'
         STR = PATH(: LNBLNK(PATH))
         CALL GTSTRING(Q,STR)
         PATH = STR(: LNBLNK(PATH))
         WRITE(USEROUT,*) 'Extension may be up to 10 characters but MUST '//
     &      'include the period if there is one'
         Q = 'Extension for scan files (i.e., .img, .v, _g3.v, or blank)'
         STR = ' '
         CALL GTSTRING(Q,STR)
         EXTENSION = STR
      END IF

C  Read PIE file

      IOPTION = .TRUE.
      PEAKUSED = .TRUE.
45    Q = 'Let the program compute the Pie Slope'
      CALL YESNO(Q,IOPTION)
      IF (IOPTION) THEN

C  Must get RCONTYPE (image type) before reading a pie file

50       Q = 'Enter the name of an image file you will be processing (without extension)'
         STR = SUBJECT(1:L)//'ho1'
         CALL GTSTRING(Q,STR)
         IMGNAME = STR
         IF (.NOT.REPROCES) THEN
            IF (STR(1:1).NE.'/') THEN
               IMGNAME = PATH(: LNBLNK(PATH))//'/'//STR(: LNBLNK(STR))//
     &                EXTENSION(: LNBLNK(EXTENSION))
            ELSE
               IMGNAME = STR(: LNBLNK(STR))//EXTENSION(: LNBLNK(EXTENSION))
            END IF
         END IF

         CALL READTYPE (ERRCODE)
         IMGTYPE = RCONTYPE
         IF (ERRCODE.LT.0) THEN
            WRITE(USEROUT,*) '>>> ERROR: Cannot read ',IMGNAME(:LNBLNK(IMGNAME)),' [',ERRCODE,']'
            GO TO 50
         ELSE IF (IMGTYPE.NE.1000 .AND. IMGTYPE.NE.1020 .AND. IMGTYPE.NE.3071
     &        .AND. IMGTYPE.NE.2000 .AND. IMGTYPE.NE.3000 .AND. IMGTYPE.NE.3070) THEN
            WRITE(USEROUT,*)'>>> ERROR: Unknown image type ',IMGTYPE
            GO TO 50
         END IF

C  For images reconstructed with new stream on PETT VI:
C  If image file does not contain NORM mean, try an attenuation image
C  (in order to get an efficiency scaler)

         IF ((IMGTYPE.EQ.1020 .OR. IMGTYPE.EQ.2000) .AND. NORMMEAN.LE.0.0) THEN
60          Q = 'Enter the name of an attenuation image'
            STR = ' '
            CALL GTSTRING(Q,STR)
            IMGNAME = STR
            IF (STR(1:1).NE.'/') THEN
               IMGNAME = PATH(: LNBLNK(PATH))//'/'//STR(: LNBLNK(STR))
            END IF

            CALL READTYPE (ERRCODE)
            IF (ERRCODE.LT.0) THEN
               WRITE(USEROUT,*) '>>> ERROR: Cannot read ',IMGNAME(:LNBLNK(IMGNAME)),' [',ERRCODE,']'
               GO TO 60
            ELSE IF (RCONTYPE.NE.1010) THEN
               WRITE(USEROUT,*)'>>> ERROR: Image type ',RCONTYPE,' is not a new attenuation image'
               GO TO 60
            END IF
         END IF

         IF (IMGTYPE.EQ.3071) THEN
            CALL GETPIE_962(PSLOPES, BNKPAIRS)
         ELSE IF (IMGTYPE.EQ.3070) THEN
            CALL GETPIE_961(PSLOPES, BNKPAIRS)
         ELSE
            CALL GETPIE(NPIES, PSLOPES, BNKPAIRS, DISK, PIENAME, IMGNAME, IMGTYPE, PMEAN, PDATE)
            IF (PIENAME.EQ.' ') GO TO 45            

            PIEMEAN = PMEAN
            PIEDATE = PDATE
   
            IF (RCONTYPE .GE. 3000) THEN
               EFACTOR = 1.0
            ELSE
               WRITE(USEROUT,*)
               WRITE(USEROUT,*) 'If you choose to enter PEAK bank pairs instead of a calculated mean,'
               WRITE(USEROUT,*) 'the program will estimate the mean.'
               WRITE(USEROUT,*) 'The program assumes your scans are of the usual length,'
               WRITE(USEROUT,*) 'and uses the following formula:'
               WRITE(USEROUT,*)
               WRITE(USEROUT,*) '  Mean Bank Pairs = Peak Bank Pairs x Factor'
               WRITE(USEROUT,*)
               WRITE(USEROUT,*)'   Scan Type     Usual Length     Factor'
               WRITE(USEROUT,*)'   ---------     ------------     ------'
               WRITE(USEROUT,*)'   H2O (CBF)        40 sec         0.9'
               WRITE(USEROUT,*)'   CO  (CBV)         5 min         0.59'
               WRITE(USEROUT,*)'   O2  (CMRO2)      40 sec         0.9'
               WRITE(USEROUT,*)
               Q = 'Are you using PEAK Bank Pairs (and NOT calculated means)'
               CALL YESNO(Q,PEAKUSED)

C  If PIEMEAN=1, no info was available in pie file for efficiency correction

               IF (PIEMEAN.EQ.1.0) THEN
                  EFACTOR = 1.0
                  WRITE(USEROUT,*) 'PETT efficiency factor set to 1.0'
               ELSE IF (IMGTYPE.NE.1020 .AND. IMGTYPE.NE.2000) THEN
                  EFACTOR = 1.0
                  WRITE(USEROUT,*) 'PETT efficiency factor set to 1.0'
               ELSE
                  DATE1 = PIEDATE
                  DATE2 = SCANDATE
                  NORM1 = PIEMEAN
                  NORM2 = NORMMEAN
                  CALL PIESCALE(NORM1,NORM2,DATE1,DATE2,EFACTOR)
                  IF (EFACTOR.LT.0.1) THEN
                      EFACTOR = 1.0
                      WRITE(USEROUT,*) 'PETT efficiency factor set to 1.0'
                  ELSE
                     WRITE(USEROUT,*)
                     WRITE(USEROUT,*) 'PETT efficiency of PIE relative to scan = ',EFACTOR
                     Q = 'Multiply pie factors by this efficiency'
                     A = .TRUE.
                     CALL YESNO(Q,A)
                     IF (.NOT.A) EFACTOR = 1.0
                  END IF
               END IF
            END IF
         END IF
      END IF

8300  FORMAT(A4,A50)
      READ(DTAFILE,8300) FILELABL,HEADER
      IF (FILELABL.EQ.'@@01@@') THEN
         FILETYPE = 4
         OLDO15 = TAUO1501
         READ(DTAFILE,*)
         READ(DTAFILE,*)
      ELSE IF (FILELABL.EQ.'@@02@@') THEN
         FILETYPE = 5
         OLDO15 = TAUO1502
         READ(DTAFILE,*)
         READ(DTAFILE,*)
      ELSE IF (FILELABL.EQ.'@@ @@@@') THEN
         FILETYPE = 3
         OLDO15 = TAUO1500
      ELSE IF (FILELABL.EQ.'@@@@@@@@') THEN
         FILETYPE = 2
         OLDO15 = TAUO1500
      ELSE
         MON = FILELABL(1:3)
         IF (MON.EQ.'JAN' .OR. MON.EQ.'FEB' .OR. MON.EQ.'MAR') GO TO 100
         IF (MON.EQ.'APR' .OR. MON.EQ.'MAY' .OR. MON.EQ.'JUN') GO TO 100
         IF (MON.EQ.'JUL' .OR. MON.EQ.'AUG' .OR. MON.EQ.'SEP') GO TO 100
         IF (MON.EQ.'OCT' .OR. MON.EQ.'NOV' .OR. MON.EQ.'DEC') GO TO 100
         WRITE(USEROUT,*) '>>> ERROR:  This is not a blood curve file',BELl
         STOP
100      FILETYPE = 1
         OLDO15 = TAUO1500
         READ(DTAFILE,*)
         READ(DTAFILE,*) N
         DO 200 I=1,(N*2)+6
            READ(DTAFILE,*)
200      CONTINUE
      END IF
      READ(DTAFILE,*) NUMSCANS

C ===================================================================
C  Loop for each scan

      DO 1000 N=1,NUMSCANS
         CALL READDTA(DTAFILE)
         IF (NTYPE.GT.9) THEN
            WRITE(USEROUT,*) '>>> ERROR: Unknown scan type=',NTYPE,' cannot be processed'
            GO TO 1000
         END IF

C  Check that the entire scan can be mapped into TIME

         IF (SCANEND.GT.TIME(NUMPNTS)) THEN
            WRITE(USEROUT,8400) SCANEND,TIME(NUMPNTS)
            STOP
         END IF
8400     FORMAT('>>> ERROR End of Scan,',F10.2,' is AFTER End of Curve,',F10.2)

C  If ntype=8, process this curve to get water counts and then get next curve (whole blood)

         IF (NTYPE.EQ.8) THEN
            CALL O2PLASMA
            WRITE(USEROUT,*) 'Processed scan type ',NTYPE,' as plasma samples'
            GO TO 1000
         END IF

C  Get parameters from the scan file header

         CALL METFILE(HDRNAME,SKIPSCAN,HDREXT)
         IF (SKIPSCAN) GO TO 1000
         IF (REPROCES) THEN
            CALL READHDR(HDRNAME,ERRCODE)
            IF (ERRCODE.LT.0) THEN
               WRITE(USEROUT,*) '>>> ERROR: Cannot read ',HDRNAME(:LNBLNK(IMGNAME)),' [',ERRCODE,']'
               GO TO 1000
            END IF
         ELSE
            CALL READTYPE (ERRCODE)
            IF (ERRCODE.LT.0) THEN
               WRITE(USEROUT,*) '>>> ERROR: Cannot read ',IMGNAME(:LNBLNK(IMGNAME)),' [',ERRCODE,']'
               GO TO 1000
            END IF
            IF (IOPTION .AND. RCONTYPE.NE.IMGTYPE) THEN
               WRITE(USEROUT,*) '>>> ERROR: Pie factors for type: ',IMGTYPE
               WRITE(USEROUT,*) '>>>        Image file is type:   ',RCONTYPE
               GO TO 1000
            END IF
         END IF

C  Get pie slope and partition coefficient

         CALL GETFACTR (IOPTION,PEAKUSED,NPIES,PSLOPES,BNKPAIRS,EFACTOR)

C  Check calibration

         EFFSCALER = EFACTOR
         Q = 'Adjust pie factor'
         CALL YESNO(Q,ADJUST)
         IF (ADJUST) THEN
            LAST = NUMPNTS
            DO WHILE (CORACTIV(LAST) .GT. 0)
               LAST = LAST-1
            END DO
            N1 = NUMPNTS - LAST 
            DO WHILE (CORACTIV(LAST) .EQ. 0)
               LAST = LAST-1
            END DO
            Q = 'Number of hand-drawn points'
            CALL GETINT(Q,N1,1,10)
            SUM = 0.
            DO 500 I=1,N1
               SUM = SUM + CORACTIV(NUMPNTS-I+1)
500         CONTINUE
            MEANHAND = SUM / FLOAT(N1)
501         Q = 'Number of automated-sampled points'
            CALL GETINT(Q,N2,1,1000)
            SUM = 0.
            CALL LINFIT (INTERCEPT, SLOPE, LAST-N2+1, LAST, COR)
            FITABS = INTERCEPT + SLOPE * TIME(NUMPNTS)
            WRITE(USEROUT,*) " R = ",COR
            EFFSCALER = MEANHAND/FITABS
            Q = 'Blood sampler efficiency scaler'
            CALL GETREAL(Q,EFFSCALER,0.0,1000.0)
            IF (EFFSCALER .LE. 0) GOTO 501
            EFFSCALER = EFFSCALER * EFACTOR
            PETTCONV(1) = EFFSCALER * PETTCONV(1)
         END IF

C  Calculate the integral of the Blood Curve Activity

         CALL INTEGRAT(TIME,ACTIVITY,0.,SCANEND,TOTALCNTS)
         CALL INTEGRAT(TIME,ACTIVITY,SCANST,SCANEND,SCANCNTS)
         WRITE(USEROUT,*) 'Blood Counts:  (Non-Decay-Corrected)'
         WRITE(USEROUT,8500) 'Injection     = ',TOTALCNTS
         WRITE(USEROUT,8500) 'Start of Scan = ',SCANCNTS
8500     FORMAT(' Integrated Blood Curve from ',A,F15.1)

C  Get Metabolic Conversion Constants appropriate to the file

         IF (NTYPE.EQ.1) THEN
            CALL O2UTIL
         ELSE IF (NTYPE.EQ.2 .OR. NTYPE.EQ.4) THEN
            CALL BLOODFLW
         ELSE IF (NTYPE.EQ.3) THEN
            CALL BLOODVOL
         ELSE IF (NTYPE.EQ.7) THEN
            CALL O2STEADY
         ELSE IF (NTYPE.EQ.9) THEN
            CALL O2INHALATION
         END IF
         COUNT(NTYPE) = COUNT(NTYPE)+1

C  Write information to .RCD file

         CALL WRITERCD (N,RCDFILE,EFFSCALER,VERSION)

C  Create the HDR file

         CALL WRITEHDR (DISK,EFFSCALER,HDRNAME)

1000  CONTINUE
C ===================================================================
      STOP
      END
@


2.31
log
@no change
@
text
@d2 3
d308 1
a308 1
      RCSHEADER = "$Id: metproc.f,v 2.29 2007/08/15 18:50:17 tom Exp tom $"
d390 1
a390 1
         Q = 'Extension for scan files (i.e., .img, .v, _5b5.v, or blank)'
@


2.29
log
@added getpie_962
@
text
@d2 3
d305 1
a305 1
      RCSHEADER = "$Id: metproc.f,v 2.28 2007/03/21 21:17:56 tom Exp tom $"
@


2.28
log
@get initials from shell
eliminate option to reprocess hdr files
@
text
@d2 4
d273 1
a273 1
      DATA VERSION /'21-Mar-2007'/
d302 1
a302 1
      RCSHEADER = "$Id: metproc.f,v 2.27 2005/08/08 16:27:56 tom Exp $"
d418 1
a418 1
         ELSE IF (IMGTYPE.NE.1000 .AND. IMGTYPE.NE.1020
d447 3
a449 1
         IF (IMGTYPE.EQ.3070) THEN
@


2.27
log
@add pie Aug 2005
@
text
@d2 3
d269 1
a269 1
      DATA VERSION /'08-Aug-2005'/
d298 1
a298 1
      RCSHEADER = "$Id: metproc.f,v 2.26 2004/11/03 15:31:15 tom Exp tom $"
d313 4
a316 2
      WRITE(USEROUT,8105) PATH(: LNBLNK(PATH)), SUBJECT
8105  FORMAT('Current Directory = ',A,/,'Subject ID = ',A)
d351 4
a354 4
      STR = ' '
      Q = 'Enter your initials (max=4)'
      CALL GTSTRING(Q,STR)
      INITIALS = STR(1:4)
a355 5
      Q = 'Default extension for HDR files (hdr or HDR)'
      STR = HDREXT(: LNBLNK(HDREXT))
      CALL GTSTRING(Q,STR)
      HDREXT = STR(1:3)

d358 6
a363 6
      WRITE(USEROUT,*) 'WARNING:  If you REPROCESS HDR files you must be certain that all'
      WRITE(USEROUT,*) 'images were processed with the same reconstruction stream.'
      WRITE(USEROUT,*) 'If they were not, the wrong pie factor may be used.'
      WRITE(USEROUT,*)
      Q = 'Reprocess existing HDR files without reading scan files'
      CALL YESNO(Q,REPROCES)
@


2.26
log
@prompt with ho1 image
@
text
@d2 3
d266 1
a266 1
      DATA VERSION /'03-Nov-2004'/
d295 1
a295 1
      RCSHEADER = "$Id: metproc.f,v 2.25 2004/11/03 14:20:17 tom Exp tom $"
@


2.25
log
@add getpie_961
@
text
@d2 3
d263 1
a263 1
      DATA VERSION /'02-Nov-2004'/
d292 1
a292 1
      RCSHEADER = "$Id: metproc.f,v 2.24 2004/11/02 16:37:24 tom Exp tom $"
d394 1
a394 1
         STR = ' '
@


2.24
log
@select 961 pies from scandate, software version, acquisition
@
text
@d2 3
a216 1
      REAL*4       PTMP
d260 1
a260 1
      DATA VERSION /'01-Nov-2004'/
a261 9
      DATA PIE_2D_1996_71 /4.66/
      DATA PIE_3D_1996_71 /3.43/
      DATA PIE_2D_1996_72 /4.51/
      DATA PIE_3D_1996_72 /3.53/
      DATA PIE_2D_2004_71 /3.77/
      DATA PIE_3D_2004_71 /2.80/
      DATA PIE_2D_2004_72 /3.74/
      DATA PIE_3D_2004_72 /2.93/
C -------------------------------------------------------------------
d289 1
a289 1
      RCSHEADER = "$Id: metproc.f,v 2.23 2004/11/02 16:35:51 tom Exp tom $"
a436 4
C  For 961 Images (type 3070):
C    Before Jul 12, 2004  2D PIE = 4.66, 3D PIE = 3.43
C    After  Aug 24, 2004  2D PIE = 3.77, 3D PIE = 2.80

d438 1
a438 86
         	WRITE(USEROUT,*) '>>> Scan Date:   ',SCANDATE
         	WRITE(USEROUT,*) '>>> Acquisition: ',ATYPE
         	WRITE(USEROUT,*) '>>> SW Version:',SW_VER
         	IF (SCANDATE(7:10).LT.'2004') THEN
         	   IF (ATYPE.EQ.'3d') THEN
         	      IF (SW_VER.GE.72) THEN
                     PSLOPES(1) = PIE_3D_1996_72
         	      ELSE
                     PSLOPES(1) = PIE_3D_1996_71
         	      ENDIF
         	   ELSE
         	      IF (SW_VER.GE.72) THEN
                     PSLOPES(1) = PIE_2D_1996_72
         	      ELSE
                     PSLOPES(1) = PIE_2D_1996_71
         	      ENDIF
         	   ENDIF
         	ELSE IF (SCANDATE(7:10).GT.'2004') THEN
         	   IF (ATYPE.EQ.'3d') THEN
         	      IF (SW_VER.GE.72) THEN
                     PSLOPES(1) = PIE_3D_2004_72
         	      ELSE
                     PSLOPES(1) = PIE_3D_2004_71
         	      ENDIF
         	   ELSE
         	      IF (SW_VER.GE.72) THEN
                     PSLOPES(1) = PIE_2D_2004_72
         	      ELSE
                     PSLOPES(1) = PIE_2D_2004_71
         	      ENDIF
         	   ENDIF
         	ELSE IF (SCANDATE(1:2).LT.'07') THEN
         	   IF (ATYPE.EQ.'3d') THEN
         	      IF (SW_VER.GE.72) THEN
                     PSLOPES(1) = PIE_3D_1996_72
         	      ELSE
                     PSLOPES(1) = PIE_3D_1996_71
         	      ENDIF
         	   ELSE
         	      IF (SW_VER.GE.72) THEN
                     PSLOPES(1) = PIE_2D_1996_72
         	      ELSE
                     PSLOPES(1) = PIE_2D_1996_71
         	      ENDIF
         	   ENDIF
         	ELSE IF (SCANDATE(1:2).GT.'08') THEN
         	   IF (ATYPE.EQ.'3d') THEN
         	      IF (SW_VER.GE.72) THEN
                     PSLOPES(1) = PIE_3D_2004_72
         	      ELSE
                     PSLOPES(1) = PIE_3D_2004_71
         	      ENDIF
         	   ELSE
         	      IF (SW_VER.GE.72) THEN
                     PSLOPES(1) = PIE_2D_2004_72
         	      ELSE
                     PSLOPES(1) = PIE_2D_2004_71
         	      ENDIF
         	   ENDIF
         	ELSE 
         	   IF (ATYPE.EQ.'3d') THEN
         	      IF (SW_VER.GE.72) THEN
                     Q = 'Ver 7.2 3D PIE between July and August 2004: 3.43 or 2.80'
                     PTMP = PIE_3D_1996_72
         	      ELSE
                     Q = '3D PIE between July and August 2004: 3.43 or 2.80'
                     PTMP = PIE_3D_1996_71
         	      ENDIF
         	   ELSE
         	      IF (SW_VER.GE.72) THEN
                     Q = 'Ver 7.2 3D PIE between July and August 2004: 3.43 or 2.80'
                     PTMP = PIE_2D_1996_72
         	      ELSE
                     Q = '2D PIE between July and August 2004: 4.66 or 3.77'
                     PTMP = PIE_2D_1996_71
         	      ENDIF
               ENDIF
               CALL GETREAL(Q,PTMP,0.0,4.66)
               PSLOPES(1) = PTMP
			ENDIF
            BNKPAIRS(1) = 0
            BNKPAIRS(2) = 999
            PSLOPES(2) = PSLOPES(1)
         	WRITE(USEROUT,8200) PSLOPES(1)
8200        FORMAT(' >>> PIE Factor: ',F5.2)
			
@


2.23
log
@*** empty log message ***
@
text
@d2 3
d296 1
a296 1
      RCSHEADER = "$Id: metproc.f,v 2.22 2004/11/01 20:02:27 tom Exp tom $"
@


2.22
log
@select 961 pies by date, sw_version, and acquisition type
@
text
@d2 3
d257 9
a278 9
C -------------------------------------------------------------------
      DATA PIE_2D_1996_71 /4.66/
      DATA PIE_3D_1996_71 /3.43/
      DATA PIE_2D_1996_72 /4.51/
      DATA PIE_3D_1996_72 /3.53/
      DATA PIE_2D_2004_71 /3.77/
      DATA PIE_3D_2004_71 /2.80/
      DATA PIE_2D_2004_72 /3.74/
      DATA PIE_3D_2004_72 /2.93/
d293 1
a293 1
      RCSHEADER = "$Id: metproc.f,v 2.21 2004/07/08 14:41:37 tom Exp tom $"
d526 3
@


2.21
log
@modify getpie for 961 versions
@
text
@d2 3
d208 1
d252 1
a252 1
      DATA VERSION /'02-Dec-2002'/
d267 9
d290 1
a290 1
      RCSHEADER = "$Id: metproc.f,v 2.20 2004/02/17 14:13:40 tom Exp tom $"
d391 1
a391 1
50       Q = 'Enter the name of an image file you will be processing'
d438 3
a440 2
         CALL GETPIE(NPIES, PSLOPES, BNKPAIRS, DISK, PIENAME, IMGNAME, IMGTYPE, PMEAN, PDATE)
         IF (PIENAME.EQ.' ') GO TO 45            
d442 84
a525 5
         PIEMEAN = PMEAN
         PIEDATE = PDATE

         IF (RCONTYPE .GE. 3000) THEN
            EFACTOR = 1.0
d527 2
a528 16
            WRITE(USEROUT,*)
            WRITE(USEROUT,*) 'If you choose to enter PEAK bank pairs instead of a calculated mean,'
            WRITE(USEROUT,*) 'the program will estimate the mean.'
            WRITE(USEROUT,*) 'The program assumes your scans are of the usual length,'
            WRITE(USEROUT,*) 'and uses the following formula:'
            WRITE(USEROUT,*)
            WRITE(USEROUT,*) '  Mean Bank Pairs = Peak Bank Pairs x Factor'
            WRITE(USEROUT,*)
            WRITE(USEROUT,*)'   Scan Type     Usual Length     Factor'
            WRITE(USEROUT,*)'   ---------     ------------     ------'
            WRITE(USEROUT,*)'   H2O (CBF)        40 sec         0.9'
            WRITE(USEROUT,*)'   CO  (CBV)         5 min         0.59'
            WRITE(USEROUT,*)'   O2  (CMRO2)      40 sec         0.9'
            WRITE(USEROUT,*)
            Q = 'Are you using PEAK Bank Pairs (and NOT calculated means)'
            CALL YESNO(Q,PEAKUSED)
d530 23
d555 6
a560 15
            IF (PIEMEAN.EQ.1.0) THEN
               EFACTOR = 1.0
               WRITE(USEROUT,*) 'PETT efficiency factor set to 1.0'
            ELSE IF (IMGTYPE.NE.1020 .AND. IMGTYPE.NE.2000) THEN
               EFACTOR = 1.0
               WRITE(USEROUT,*) 'PETT efficiency factor set to 1.0'
            ELSE
               DATE1 = PIEDATE
               DATE2 = SCANDATE
               NORM1 = PIEMEAN
               NORM2 = NORMMEAN
               CALL PIESCALE(NORM1,NORM2,DATE1,DATE2,EFACTOR)
               IF (EFACTOR.LT.0.1) THEN
                   EFACTOR = 1.0
                   WRITE(USEROUT,*) 'PETT efficiency factor set to 1.0'
d562 16
a577 6
                  WRITE(USEROUT,*)
                  WRITE(USEROUT,*) 'PETT efficiency of PIE relative to scan = ',EFACTOR
                  Q = 'Multiply pie factors by this efficiency'
                  A = .TRUE.
                  CALL YESNO(Q,A)
                  IF (.NOT.A) EFACTOR = 1.0
@


2.20
log
@Feb 2004
@
text
@d2 3
d277 1
a277 1
      RCSHEADER = "$Id: metproc.f,v 2.18 2002/12/02 17:08:36 tom Exp tom $"
@


2.18
log
@modifications for gcc
@
text
@d2 3
d274 1
a274 1
      RCSHEADER = "$Id: metproc.f,v 2.17 2001/06/01 18:48:41 tom Exp tom $"
@


2.17
log
@ntype = 7 for steady-state oxygen
@
text
@d2 3
a212 1
      CHARACTER*1   BELL
d233 10
a242 8
      DATA SCANTYPE(1) /'Oxygen              '/
      DATA SCANTYPE(2) /'Blood Flow (H2O)    '/
      DATA SCANTYPE(3) /'Blood Volume (CO)   '/
      DATA SCANTYPE(4) /'Blood Flow (Butanol)'/
      DATA SCANTYPE(5) /'Spiperone           '/
      DATA SCANTYPE(6) /'Glucose             '/
      DATA SCANTYPE(7) /'Oxygen: Steady-State'/
      DATA VERSION /'24-May-2001'/
a263 1

a265 1

a267 1

d271 1
a271 2
      RCSHEADER = "$Id: metproc.f,v 2.16 1999/12/16 15:27:47 tom Exp tom $"
      BELL = CHAR(7)
d275 1
d388 1
a388 1
            WRITE(USEROUT,*) '>>> ERROR: Cannot read ',IMGNAME(:LNBLNK(IMGNAME)),'\>>>',ERRCODE,BELL
d392 1
a392 1
            WRITE(USEROUT,*)'>>> ERROR: Unknown image type ',IMGTYPE,BELL
d411 1
a411 1
               WRITE(USEROUT,*) '>>> ERROR: Cannot read ',IMGNAME(:LNBLNK(IMGNAME)),'\>>>',ERRCODE,BELL
d414 1
a414 1
               WRITE(USEROUT,*)'>>> ERROR: Image type ',RCONTYPE,' is not a new attenuation image',BELL
d515 2
a516 2
         IF (NTYPE.GT.7) THEN
            WRITE(USEROUT,*) '>>> ERROR: Scan type ',NTYPE,' cannot be processed',BELL
d528 8
d543 1
a543 1
               WRITE(USEROUT,*) '>>> ERROR: Cannot read ',HDRNAME(:LNBLNK(IMGNAME)),'\>>>',ERRCODE,BELL
d549 1
a549 1
               WRITE(USEROUT,*) '>>> ERROR: Cannot read ',IMGNAME(:LNBLNK(IMGNAME)),'\>>>',RCONTYPE,BELL
d554 1
a554 1
               WRITE(USEROUT,*) '>>>        Image file is type:   ',RCONTYPE,BELL
d565 1
d617 2
@


2.16
log
@clean up
@
text
@d2 3
a154 1
C  Uses Subroutines:
d180 1
a180 1
C
d183 8
a190 8
      INTEGER*4      DTAFILE   ! file descriptor (lu) of .DTA file
      INTEGER*4      RCDFILE   ! file descriptor (lu) of .RCD file
      INTEGER*4      DISK      ! file descriptor (lu) for image, PIE, and HDR files
      INTEGER*4      NPIES      ! number of PSLOPES/BNKPAIRS
      INTEGER*4      I,L,N
      INTEGER*4      IMGTYPE
      INTEGER*4      N1, N2, LAST
      REAL*4         EFFSCALER, MEANHAND, FITABS, SUM, SLOPE, INTERCEPT, COR
d192 1
a192 1
      REAL*4       BNKPAIRS(10)   ! bank pairs read from PIE file
d214 1
a214 1
      CHARACTER*4   FILELABL   ! 4 characters at the beginning of a DTA file
d223 3
a225 3
      CHARACTER*256   HDRNAME   ! name of .HDR file
      CHARACTER*256   DTANAME   ! name of .DTA file
      CHARACTER*256   RCDNAME   ! name of .RCD file
d237 2
a238 1
      DATA VERSION /'16-Dec-1999'/
d253 1
a253 1
C
d260 1
a260 1
C
d263 1
a263 1
C
d266 1
a266 1
C
d270 1
a270 1
      RCSHEADER = "$Id: metproc.f,v 2.15 1999/12/15 22:49:03 tom Exp tom $"
d287 1
a287 1
      DO 10 I=1,6
d472 1
a472 1
C
d514 1
a514 1
         IF (NTYPE.GT.6) THEN
d605 2
a619 1

@


2.15
log
@format fix
@
text
@d2 3
a66 1
C
a68 1
C
a152 1
C
a176 1
C
a183 1

a186 1

a188 1

a193 1

d201 1
a201 1
      LOGICAL*1    ERRFLAG
d214 2
a215 1
      CHARACTER*8   DATE1, DATE2, PDATE
d235 1
a235 1
      DATA VERSION /'15-Dec-1999'/
d266 2
a267 2
C
      RCSHEADER = "$Id: metproc.f,v 2.14 1999/12/15 22:41:18 tom Exp tom $"
d276 3
a278 10
8100  FORMAT(19X,A44)
8101  FORMAT(34X,A1,A11,A1)
      WRITE(USEROUT,8100)'********************************************'
      WRITE(USEROUT,8100)'     METABOLIC PROCESSING of SCAN FILES     '
      WRITE(USEROUT,8101)'(',VERSION,')'
      WRITE(USEROUT,8100)'                UNIX version                '
      WRITE(USEROUT,8100)'             Creates .HDR Files             '
      WRITE(USEROUT,8100)'********************************************'
      WRITE(USEROUT,*)

d282 1
a282 1
      WRITE(USEROUT,8105) PATH( : LNBLNK(PATH)), SUBJECT
d302 1
a302 1
30    WRITE(USEROUT,8115) DTANAME( : LNBLNK(DTANAME))
d310 1
a310 1
35    WRITE(USEROUT,8120) RCDNAME( : LNBLNK(RCDNAME))
d312 1
a312 1
40    WRITE(USEROUT,8125) RCDNAME( : LNBLNK(RCDNAME))
d324 1
a324 1
      STR = HDREXT( : LNBLNK(HDREXT))
a329 1
      WRITE(USEROUT,*)
d341 1
a341 1
         STR = PATH
d343 1
a343 1
         PATH = STR
d347 1
a347 1
         STR = PATH
d349 1
a349 1
         PATH = STR
d374 2
a375 2
               IMGNAME = PATH( : LNBLNK(PATH))//'/'//STR( : LNBLNK(STR))//
     &                EXTENSION( : LNBLNK(EXTENSION))
d377 1
a377 1
               IMGNAME = STR( : LNBLNK(STR))//EXTENSION( : LNBLNK(EXTENSION))
d381 1
a381 1
         CALL READTYPE (ERRFLAG)
d383 2
a384 2
         IF (ERRFLAG) THEN
            WRITE(USEROUT,*) '*** Cannot read ',IMGNAME( :LNBLNK(IMGNAME)),BELL
d388 1
a388 2
            WRITE(USEROUT,*)'*** ERROR: Image Type ',IMGTYPE,
     &         ' is incompatable with this program.',BELL
d402 1
a402 1
               IMGNAME = PATH( : LNBLNK(PATH))//'/'//STR( : LNBLNK(STR))
d405 3
a407 3
            CALL READTYPE (ERRFLAG)
            IF (ERRFLAG) THEN
               WRITE(USEROUT,*) '*** Cannot read ',IMGNAME(:LNBLNK(IMGNAME)),BELL
d410 1
a410 2
               WRITE(USEROUT,*)'*** ERROR: Image Type ',RCONTYPE,
     &           ' is not a new attenuation image.',BELL
d460 1
a460 2
                  WRITE(USEROUT,*) 'PETT efficiency of PIE relative to ',
     &              'scan = ',EFACTOR
d494 1
a494 2
         WRITE(USEROUT,*) '*** ERROR:  This is not a blood curve file',
     &      BELL
d512 1
a512 2
            WRITE(USEROUT,*) '*** This scan matches no known type ***'
            WRITE(USEROUT,*) '*** and CANNOT BE PROCESSED       ***',BELL
d515 1
a515 1
C
d517 1
a517 1
C
d522 2
a523 2
8400     FORMAT('*** ERROR End of Scan,',F10.2,' is AFTER End of Curve,',F10.2)
C
d525 1
a525 1
C
d529 3
a531 5
            CALL READHDR(HDRNAME,ERRFLAG)
            IF (ERRFLAG) THEN
               WRITE(USEROUT,*) 'Cannot read HDR file'
               WRITE(USEROUT,*) 'File was NOT processed',BELL
               WRITE(USEROUT,*)
d535 3
a537 6
            CALL READTYPE (ERRFLAG)
            IF (IOPTION .AND. RCONTYPE.NE.IMGTYPE) THEN
               WRITE(USEROUT,*) '*** ERROR:',BELL
               WRITE(USEROUT,*) '*** Pie factors were read for type ',IMGTYPE
               WRITE(USEROUT,*) '*** Image is of type ',RCONTYPE,' and can NOT be processed.'
               WRITE(USEROUT,*)
d540 3
a542 5
            IF (ERRFLAG) THEN
               WRITE(USEROUT,*) '** ERROR:',BELL
               WRITE(USEROUT,*) '** File type is not PETT VI or Super PETT'
               WRITE(USEROUT,*) '** and can NOT be processed.'
               WRITE(USEROUT,*)
d574 1
a574 1
			CALL LINFIT (INTERCEPT, SLOPE, LAST-N2+1, LAST, COR)
d576 1
a576 1
	        WRITE(USEROUT,*) " R = ",COR
d580 3
a582 3
			IF (EFFSCALER .LE. 0) GOTO 501
			EFFSCALER = EFFSCALER * EFACTOR
			PETTCONV(1) = EFFSCALER * PETTCONV(1)
@


2.14
log
@y2k and lint clean
@
text
@d2 3
d271 1
a271 1
      RCSHEADER = "$Id: metproc.f,v 2.13 1998/07/15 16:52:25 tom Exp tom $"
d281 1
a281 1
8101  FORMAT(35X,A1,A9,A1)
@


2.13
log
@increased array sizes in metproc.inc
@
text
@d2 3
d217 1
a217 1
      CHARACTER*9   VERSION
d236 1
a236 1
      DATA VERSION /'15-Jul-98'/
d268 1
a268 1
      RCSHEADER = "$Id: metproc.f,v 2.12 1997/03/19 20:20:07 tom Exp tom $"
d457 3
d466 3
a468 4
               IF ((IMGTYPE.NE.1020 .AND. IMGTYPE.NE.2000) .OR.
     &            EFACTOR.LT.0.1) THEN
                  EFACTOR = 1.0
                  WRITE(USEROUT,*) 'PETT efficiency factor set to 1.0'
@


2.12
log
@fix getimagetype.c   getimginfo.c
@
text
@d2 3
d233 1
a233 1
      DATA VERSION /'19-Mar-97'/
d265 1
a265 1
      RCSHEADER = "$Id: metproc.f,v 2.11 1997/03/10 17:15:28 tom Exp tom $"
@


2.11
log
@use firstimgfrm in getimagetype and getimginfo
@
text
@d2 3
d230 1
a230 1
      DATA VERSION /'10-Mar-97'/
d262 1
a262 1
      RCSHEADER = "$Id: metproc.f,v 2.10 1997/03/10 16:18:32 tom Exp tom $"
@


2.10
log
@read frame 1,2, or 3
@
text
@d2 3
d259 1
a259 1
      RCSHEADER = "$Id: metproc.f,v 2.9 1997/01/20 19:00:46 tom Exp tom $"
@


2.9
log
@appropriate factor for JMO 3D reconstructed images
@
text
@d2 3
d224 1
a224 1
      DATA VERSION /'20-Jan-97'/
d256 1
a256 1
      RCSHEADER = "$Id: metproc.f,v 2.8 1996/10/29 22:19:37 tom Exp tom $"
@


2.8
log
@change N2=60 for default
@
text
@d2 3
d221 1
a221 1
      DATA VERSION /'29-Oct-96'/
d253 1
a253 1
      RCSHEADER = "$Id: metproc.f,v 2.7 1996/10/29 19:27:43 tom Exp tom $"
@


2.7
log
@permit adjustment of calibration using hand-drawn sample
@
text
@d2 3
d250 1
a250 1
      RCSHEADER = "$Id: metproc.f,v 2.6 1996/10/16 16:52:28 tom Exp tom $"
d258 1
a258 1
      N2 = 30
@


2.6
log
@new libimage
@
text
@d2 3
d166 3
d185 2
d215 1
a215 1
      DATA VERSION /'14-Oct-96'/
d247 1
a247 1
      RCSHEADER = "$Id: metproc.f,v 2.5 1996/10/14 20:55:02 tom Exp tom $"
d253 1
d255 1
d549 34
d605 1
a605 1
         CALL WRITERCD (N,RCDFILE,EFACTOR,VERSION)
d609 1
a609 1
         CALL WRITEHDR (DISK,EFACTOR,HDRNAME)
@


2.5
log
@solaris
@
text
@d2 3
d239 1
a239 1
      RCSHEADER = "$Id: metproc.f,v 2.4 1995/12/20 04:33:22 tom Exp tom $"
@


2.4
log
@961 version
@
text
@d2 3
d204 1
a204 1
      DATA VERSION /'20-Dec-95'/
d236 1
a236 1
      RCSHEADER = "$Id: metproc.f,v 2.3 1993/10/15 17:51:17 tom Exp tom $"
@


2.3
log
@fix bug in get_recon_type
@
text
@d2 3
d87 30
a116 30
C			Modified for UNIX by TOV 14-Jan to 14-Feb-92:
C				USERIN = 5; USEROUT = 6 (defaults)
C				All files opened internally by name. 
C					PIENAME, DTANAME, RCDNAME, IMGNAME, HDRNAME 
C				Add subroutines: GETARG, GETCWD, ieee2pe
C				Eliminate TERMSET, TCONTROL
C				Changes in:   BLOODFLW, GETIMAGE, GETPIE, INTCONV, METFILE, METPROC
C					READDTA, READHEAD, SAVEPIE, WRITEHDR, WRITERCD, METPROC.INC
C			Modified 12-May-92 by TOV 
C				1) to incorporate libpetutil and libpe.
C						Changes in:	Makefile, WRITEHDR, READHEAD
C						Use GETIMG from libpetutil.
C				2) changed remaining FNAME to IMGNAME
C						Changes in: METFILE, READHDR
C			Modified 28-Oct-92 by TOV
C				1) read dta, DTA, or DAT files (in that order)
C				2) read ECAT pie files (type 7) (getpie.f)
C				3) change extension RCD to rcd
C				4) Default extension for hdrfile is 'hdr' (HDREXT).
C				5) Added HDREXT to call to METFILE (metfile.f)
C			Modified 19-May-93 by TOV
C				1) read ECAT pie files (type 7) (getpie.f)
C				2) user must enter pie file extension (getpie.f)
C			Modified 12-Jul-93 by TO
C				1) read ECAT image files and correct pie according to type of image
C				2) eliminate PIEFILE routine with SAVEPIE option
C				3) eliminate call uppercase(piename)
C			Modified 15-Oct-93 by TOV
C				1) time activity curves of 1000 points ok (metproc.inc)
C				2) fix bug in get_recon_type for scan_month
d123 1
a123 1
C     READHEAD - read selected paramters from scan file header;
d140 4
a143 4
C		Sun FORTRAN
C			GETARG
C			GETCWD
C			LNBLNK
d148 11
a158 11
C
      INTEGER*4		DTAFILE	! file descriptor (lu) of .DTA file
      INTEGER*4		RCDFILE	! file descriptor (lu) of .RCD file
      INTEGER*4		DISK		! file descriptor (lu) for image, PIE, and HDR files
C
      INTEGER*4		NPIES		! number of PSLOPES/BNKPAIRS
      INTEGER*4		I,L,N
      INTEGER*4		IMGTYPE
C
      REAL*4       PSLOPES(10)	! pie slopes read from PIE file
      REAL*4       BNKPAIRS(10)	! bank pairs read from PIE file
d162 8
a169 8
C
      LOGICAL*1    PEAKUSED	! true--> user enters peak of Bank Pairs and
C																			program estimates the mean;
C															false--> user enters mean Bank Pairs;
      LOGICAL*1    SKIPSCAN	!	true--> do not process the scan;
C															false--> process the scan;
      LOGICAL*1    IOPTION	! true--> Pie Slope is computed internally by
C        reading a PIE file and interpolating peak bank pairs;
d171 2
a172 2
      LOGICAL*1    REPROCES	! true--> reprocess existing HDR files
C                false-->get scan parameters from original scan files;
d174 3
a176 3
C
      CHARACTER*1		BELL
      CHARACTER*3		MON
d178 13
a190 13
			CHARACTER*3		FSTATUS	! file status (OLD or NEW)
      CHARACTER*4		FILELABL	! 4 characters at the beginning of a DTA file
C				which are used to check agreement with the current program version;
      CHARACTER*8		DATE1, DATE2, PDATE
      CHARACTER*9		VERSION
      CHARACTER*80	Q
			CHARACTER*256 STR
			CHARACTER*256 RCSHEADER
C
			CHARACTER*256	HDRNAME	! name of .HDR file
      CHARACTER*256	DTANAME	! name of .DTA file
      CHARACTER*256	RCDNAME	! name of .RCD file
C
d192 3
a194 3
C
			DATA DTAFILE, RCDFILE, DISK /1,2,3/
			DATA USERIN, USEROUT /5,6/
d201 1
a201 1
      DATA VERSION /'15-Oct-93'/
d233 1
a233 1
			RCSHEADER = "$Id: metproc.f,v 2.2 1993/10/15 16:33:22 tom Exp tom $"
d235 1
a235 1
			HDREXT = 'hdr'
d239 1
a239 1
			PIEMEAN = 1.0
d249 3
a251 3
C
			CALL GETENV('PWD',PATH)
			CALL GETARG(1,SUBJECT)
d253 2
a254 2
			WRITE(USEROUT,8105) PATH( : LNBLNK(PATH)), SUBJECT
8105	FORMAT('Current Directory = ',A,/,'Subject ID = ',A)
d256 1
a256 1
        COUNT(I) = 1
d258 1
a258 1
C
d260 27
a286 27
C			
			DTANAME = SUBJECT(1:L)//'.dta'
			FSTATUS = 'OLD'
			OPEN(DTAFILE,FILE=DTANAME,STATUS='OLD',ERR=15)
			GO TO 30
15		DTANAME = SUBJECT(1:L)//'.DTA'
			OPEN(DTAFILE,FILE=DTANAME,STATUS='OLD',ERR=20)
			GO TO 30
20		DTANAME = SUBJECT(1:L)//'.DAT'
			OPEN(DTAFILE,FILE=DTANAME,STATUS='OLD',ERR=25)
			GO TO 30
25		WRITE(USEROUT,8110) SUBJECT(1:L), SUBJECT(1:L)
			STOP
30		WRITE(USEROUT,8115) DTANAME( : LNBLNK(DTANAME))
C
8110	FORMAT('Neither blood curve file ',A,'.dta ',A,'.DTA nor ',A,'.DAT exists!')
8115	FORMAT('Reading blood curve from ',A)
C
			RCDNAME = SUBJECT(1:L)//'.rcd'
			OPEN(RCDFILE,FILE=RCDNAME,ERR=35)
			GO TO 40
35		WRITE(USEROUT,8120) RCDNAME( : LNBLNK(RCDNAME))
			STOP
40		WRITE(USEROUT,8125) RCDNAME( : LNBLNK(RCDNAME))
8120	FORMAT('Cannot open file ',A)
8125	FORMAT('Log of processing will be written to ',A)
C
d288 2
a289 2
C
	    STR = ' '
d293 1
a293 1
C
d298 1
a298 1
C
d300 1
a300 1
C
d308 1
a308 1
C
d310 1
a310 1
C
d312 5
a316 5
        Q = 'Directory path for HDR files'
        STR = PATH
        CALL GTSTRING(Q,STR)
        PATH = STR
        EXTENSION = HDREXT
d318 10
a327 10
        Q = 'Directory path for scan files'
        STR = PATH
        CALL GTSTRING(Q,STR)
        PATH = STR
				WRITE(USEROUT,*) 'Extension may be up to 10 characters but MUST '//
     &		'include the period if there is one'
        Q = 'Extension for scan files (i.e., .img, .c, or blank)'
        STR = ' '
        CALL GTSTRING(Q,STR)
        EXTENSION = STR
d329 1
a329 1
C
d331 1
a331 1
C
d337 1
a337 1
C
a338 13
C
50      Q = 'Enter the name of an image file you will be processing'
        STR = ' '
        CALL GTSTRING(Q,STR)
        IMGNAME = STR
        IF (.NOT.REPROCES) THEN
          IF (STR(1:1).NE.'/') THEN
            IMGNAME = PATH( : LNBLNK(PATH))//'/'//STR( : LNBLNK(STR))//
     &					EXTENSION( : LNBLNK(EXTENSION))
					ELSE
            IMGNAME = STR( : LNBLNK(STR))//EXTENSION( : LNBLNK(EXTENSION))
          END IF
        END IF
d340 25
a364 12
        CALL READHEAD(DISK,ERRFLAG)
        IMGTYPE = RCONTYPE
        IF (ERRFLAG) THEN
          WRITE(USEROUT,*) '*** Cannot read ',IMGNAME( :LNBLNK(IMGNAME)),BELL
          GO TO 50
        ELSE IF (IMGTYPE.NE.1000 .AND. IMGTYPE.NE.1020
     &     .AND. IMGTYPE.NE.2000 .AND. IMGTYPE.NE.3000) THEN
          WRITE(USEROUT,*)'*** ERROR: Image Type ',IMGTYPE,
     &      ' is incompatable with this program.',BELL
          GO TO 50
        END IF
C
d368 47
a414 47
C
        IF ((IMGTYPE.EQ.1020 .OR. IMGTYPE.EQ.2000) .AND. NORMMEAN.LE.0.0) THEN
60        Q = 'Enter the name of an attenuation image'
          STR = ' '
          CALL GTSTRING(Q,STR)
          IMGNAME = STR
          IF (STR(1:1).NE.'/') THEN
            IMGNAME = PATH( : LNBLNK(PATH))//'/'//STR( : LNBLNK(STR))
          END IF
C
          CALL READHEAD(DISK,ERRFLAG)
          IF (ERRFLAG) THEN
            WRITE(USEROUT,*) '*** Cannot read ',IMGNAME(:LNBLNK(IMGNAME)),BELL
            GO TO 60
          ELSE IF (RCONTYPE.NE.1010) THEN
            WRITE(USEROUT,*)'*** ERROR: Image Type ',RCONTYPE,
     &        ' is not a new attenuation image.',BELL
            GO TO 60
          END IF
        END IF
C
        CALL GETPIE(NPIES, PSLOPES, BNKPAIRS, DISK, PIENAME, IMGNAME, IMGTYPE, PMEAN, PDATE)
				IF (PIENAME.EQ.' ') GO TO 45				
C
        PIEMEAN = PMEAN
        PIEDATE = PDATE
C
				IF (RCONTYPE .EQ. 3000) THEN
					EFACTOR = 1.0
				ELSE
					WRITE(USEROUT,*)
        	WRITE(USEROUT,*) 'If you choose to enter PEAK bank pairs instead of a calculated mean,'
        	WRITE(USEROUT,*) 'the program will estimate the mean.'
        	WRITE(USEROUT,*) 'The program assumes your scans are of the usual length,'
        	WRITE(USEROUT,*) 'and uses the following formula:'
        	WRITE(USEROUT,*)
        	WRITE(USEROUT,*) '  Mean Bank Pairs = Peak Bank Pairs x Factor'
        	WRITE(USEROUT,*)
        	WRITE(USEROUT,*)'   Scan Type     Usual Length     Factor'
        	WRITE(USEROUT,*)'   ---------     ------------     ------'
        	WRITE(USEROUT,*)'   H2O (CBF)        40 sec         0.9'
        	WRITE(USEROUT,*)'   CO  (CBV)         5 min         0.59'
        	WRITE(USEROUT,*)'   O2  (CMRO2)      40 sec         0.9'
        	WRITE(USEROUT,*)
        	Q = 'Are you using PEAK Bank Pairs (and NOT calculated means)'
        	CALL YESNO(Q,PEAKUSED)
C
d416 26
a442 26
        	IF (PIEMEAN.EQ.1.0) THEN
         		EFACTOR = 1.0
          	WRITE(USEROUT,*) 'PETT efficiency factor set to 1.0'
        	ELSE
          	DATE1 = PIEDATE
          	DATE2 = SCANDATE
          	NORM1 = PIEMEAN
          	NORM2 = NORMMEAN
        		CALL PIESCALE(NORM1,NORM2,DATE1,DATE2,EFACTOR)
          	IF ((IMGTYPE.NE.1020 .AND. IMGTYPE.NE.2000) .OR.
     &    	    EFACTOR.LT.0.1) THEN
           		EFACTOR = 1.0
            	WRITE(USEROUT,*) 'PETT efficiency factor set to 1.0'
          	ELSE
            	WRITE(USEROUT,*)
            	WRITE(USEROUT,*) 'PETT efficiency of PIE relative to ',
     &      	  'scan = ',EFACTOR
            	Q = 'Multiply pie factors by this efficiency'
            	A = .TRUE.
            	CALL YESNO(Q,A)
            	IF (.NOT.A) EFACTOR = 1.0
          	END IF
        	END IF
      	END IF
			END IF
C
d446 4
a449 4
        FILETYPE = 4
        OLDO15 = TAUO1501
        READ(DTAFILE,*)
        READ(DTAFILE,*)
d451 4
a454 4
        FILETYPE = 5
        OLDO15 = TAUO1502
        READ(DTAFILE,*)
        READ(DTAFILE,*)
d456 2
a457 2
        FILETYPE = 3
        OLDO15 = TAUO1500
d459 2
a460 2
        FILETYPE = 2
        OLDO15 = TAUO1500
d462 15
a476 15
        MON = FILELABL(1:3)
        IF (MON.EQ.'JAN' .OR. MON.EQ.'FEB' .OR. MON.EQ.'MAR') GO TO 100
        IF (MON.EQ.'APR' .OR. MON.EQ.'MAY' .OR. MON.EQ.'JUN') GO TO 100
        IF (MON.EQ.'JUL' .OR. MON.EQ.'AUG' .OR. MON.EQ.'SEP') GO TO 100
        IF (MON.EQ.'OCT' .OR. MON.EQ.'NOV' .OR. MON.EQ.'DEC') GO TO 100
        WRITE(USEROUT,*) '*** ERROR:  This is not a blood curve file',
     2    BELL
        STOP
100     FILETYPE = 1
        OLDO15 = TAUO1500
        READ(DTAFILE,*)
        READ(DTAFILE,*) N
        DO 200 I=1,(N*2)+6
          READ(DTAFILE,*)
200     CONTINUE
d479 1
a479 1
C
d482 1
a482 1
C
d484 6
a489 6
        CALL READDTA(DTAFILE)
        IF (NTYPE.GT.6) THEN
          WRITE(USEROUT,*) '*** This scan matches no known type ***'
          WRITE(USEROUT,*) '*** and CANNOT BE PROCESSED       ***',BELL
          GO TO 1000
        END IF
d493 5
a497 5
        IF (SCANEND.GT.TIME(NUMPNTS)) THEN
          WRITE(USEROUT,8400) SCANEND,TIME(NUMPNTS)
          STOP
        END IF
8400    FORMAT('*** ERROR End of Scan,',F10.2,' is AFTER End of Curve,',F10.2)
d501 28
a528 28
        CALL METFILE(HDRNAME,SKIPSCAN,HDREXT)
        IF (SKIPSCAN) GO TO 1000
        IF (REPROCES) THEN
          CALL READHDR(HDRNAME,ERRFLAG)
          IF (ERRFLAG) THEN
            WRITE(USEROUT,*) 'Cannot read HDR file'
            WRITE(USEROUT,*) 'File was NOT processed',BELL
            WRITE(USEROUT,*)
            GO TO 1000
          END IF
        ELSE
          CALL READHEAD(DISK,ERRFLAG)
          IF (IOPTION .AND. RCONTYPE.NE.IMGTYPE) THEN
            WRITE(USEROUT,*) '*** ERROR:',BELL
            WRITE(USEROUT,*) '*** Pie factors were read for type ',IMGTYPE
            WRITE(USEROUT,*) '*** Image is of type ',RCONTYPE,' and can NOT be processed.'
            WRITE(USEROUT,*)
            GO TO 1000
          END IF
          IF (ERRFLAG) THEN
            WRITE(USEROUT,*) '** ERROR:',BELL
            WRITE(USEROUT,*) '** File type is not PETT VI or Super PETT'
            WRITE(USEROUT,*) '** and can NOT be processed.'
            WRITE(USEROUT,*)
            GO TO 1000
          END IF
        END IF
C
d530 3
a532 3
C
        CALL GETFACTR (IOPTION,PEAKUSED,NPIES,PSLOPES,BNKPAIRS,EFACTOR)
C
d534 8
a541 8
C
        CALL INTEGRAT(TIME,ACTIVITY,0.,SCANEND,TOTALCNTS)
        CALL INTEGRAT(TIME,ACTIVITY,SCANST,SCANEND,SCANCNTS)
        WRITE(USEROUT,*) 'Blood Counts:  (Non-Decay-Corrected)'
        WRITE(USEROUT,8500) 'Injection     = ',TOTALCNTS
        WRITE(USEROUT,8500) 'Start of Scan = ',SCANCNTS
8500    FORMAT(' Integrated Blood Curve from ',A,F15.1)
C
d543 10
a552 10
C
        IF (NTYPE.EQ.1) THEN
          CALL O2UTIL
        ELSE IF (NTYPE.EQ.2 .OR. NTYPE.EQ.4) THEN
          CALL BLOODFLW
        ELSE IF (NTYPE.EQ.3) THEN
          CALL BLOODVOL
        END IF
        COUNT(NTYPE) = COUNT(NTYPE)+1
C
d554 3
a556 3
C
        CALL WRITERCD (N,RCDFILE,EFACTOR,VERSION)
C
d558 3
a560 3
C
        CALL WRITEHDR (DISK,EFACTOR,HDRNAME)
C
d563 1
a563 1
C
@


2.2
log
@change tive-activity arrays from 200 to 1000
@
text
@d2 3
d113 1
d230 1
a230 1
			RCSHEADER = "$Id: metproc.f,v 2.1 1993/07/15 20:25:17 tom Exp tom $"
@


2.1
log
@Corrected error in pie adjustment for no scatter-correction
Changed RCSHEADER to ID
@
text
@d2 4
d108 2
d194 1
a194 1
      DATA VERSION /'15-Jul-93'/
d226 1
a226 1
			RCSHEADER = "$Id$"
@


2.0
log
@Handles ECAT image format
@
text
@d2 3
d188 1
a188 1
      DATA VERSION /'12-Jul-93'/
d220 1
a220 1
			RCSHEADER = "$Header: /home/petsun2/tom/src/metproc/src/RCS/metproc.f,v 1.5 1993/07/12 22:48:11 tom Exp tom $"
@


1.5
log
@Revised to handle ECAT images
PIE factors are adjusted for the type of reconstruction and acquisition
@
text
@d2 4
d217 1
a217 1
			RCSHEADER = "$Header: /export/home/petsun2/tom/src/metproc/src/RCS/metproc.f,v 1.4 1992/11/02 16:27:14 tom Exp tom $"
@


1.4
log
@*** empty log message ***
@
text
@d2 3
d90 7
d105 1
a106 1
C     PIEFILE  - read or write PIE files;
a117 1
C     UPPERCAS
d141 1
d161 1
a161 1
      CHARACTER*8		DATE1, DATE2
d181 1
a181 1
      DATA VERSION /'28-Oct-92'/
d213 1
a213 1
			RCSHEADER = "$Header: /usr/local/src/metproc/RCS/metproc.f,v 1.3 1992/10/19 15:56:10 tom Exp tom $"
d282 3
a284 6
      WRITE(USEROUT,*) 'WARNING:  If you REPROCESS HDR files, ',
     2  'you must be certain that all'
      WRITE(USEROUT,*) 'images were processed with the same ',
     2  'reconstruction stream.'
      WRITE(USEROUT,*) 'If they were not, the wrong pie factor ',
     2  'may be used.'
d304 2
a305 2
        Q = 'Extension for scan files (i.e., .IMG, .CMG, .C, ., or blank)'
        STR = '.C'
d320 1
a320 1
50      Q = 'Enter the name of 1 image file you will be processing'
d332 1
d349 1
a349 2
        IF ((IMGTYPE.EQ.1020 .OR. IMGTYPE.EQ.2000)
     &      .AND. NORMMEAN.LE.0.0) THEN
d369 1
a369 1
        CALL PIEFILE(NPIES,PSLOPES,BNKPAIRS,DISK,IMGTYPE)
d372 2
a373 19
        WRITE(USEROUT,*)
        WRITE(USEROUT,*) 'If you choose to enter PEAK bank pairs ',
     2    'instead of a calculated mean,'
        WRITE(USEROUT,*) 'the program will estimate the mean.'
        WRITE(USEROUT,*) 'The program assumes your scans are of the ',
     2    'usual length,'
        WRITE(USEROUT,*) 'and uses the following formula:'
        WRITE(USEROUT,*)
        WRITE(USEROUT,*) '  Mean Bank Pairs = Peak Bank Pairs x Factor'
        WRITE(USEROUT,*)
        WRITE(USEROUT,*)'   Scan Type     Usual Length     Factor'
        WRITE(USEROUT,*)'   ---------     ------------     ------'
        WRITE(USEROUT,*)'   H2O (CBF)        40 sec         0.9'
        WRITE(USEROUT,*)'   CO  (CBV)         5 min         0.59'
        WRITE(USEROUT,*)'   O2  (CMRO2)      40 sec         0.9'
        WRITE(USEROUT,*)
        Q = 'Are you using PEAK Bank Pairs (and NOT calculated means)'
        CALL YESNO(Q,PEAKUSED)
        CALL UPPERCAS(PIENAME,256)
d375 20
d397 25
a421 26
        IF (PIEMEAN.EQ.1.0) THEN
          EFACTOR = 1.0
          WRITE(USEROUT,*) 'PETT efficiency factor set to 1.0'
        ELSE
          DATE1 = PIEDATE
          DATE2 = SCANDATE
          NORM1 = PIEMEAN
          NORM2 = NORMMEAN
        	CALL PIESCALE(NORM1,NORM2,DATE1,DATE2,EFACTOR)
          IF ((IMGTYPE.NE.1020 .AND. IMGTYPE.NE.2000) .OR.
     &        EFACTOR.LT.0.1) THEN
            EFACTOR = 1.0
            WRITE(USEROUT,*) 'PETT efficiency factor set to 1.0'
          ELSE
            WRITE(USEROUT,*)
            WRITE(USEROUT,*) 'PETT efficiency of PIE relative to ',
     &        'scan = ',EFACTOR
            Q = 'Multiply pie factors by this efficiency'
            A = .TRUE.
            CALL YESNO(Q,A)
            IF (.NOT.A) EFACTOR = 1.0
          END IF
        END IF
      ELSE
        PIENAME = ' '
      END IF
d477 1
a477 2
8400    FORMAT('*** ERROR End of Scan,',F10.2,
     2      ' is AFTER End of Curve,',F10.2)
d495 2
a496 4
            WRITE(USEROUT,*) '*** Pie factors were read for type ',
     2        IMGTYPE
            WRITE(USEROUT,*) '*** Image is of type ',RCONTYPE,
     2        ' and can NOT be processed.'
a506 8
          IF (SLICES.GT.7) THEN
            WRITE(USEROUT,*) '*** ERROR:',BELL
            WRITE(USEROUT,*) '*** METPROC does not currently support ',
     2         SLICES,'-slice studies.'
            WRITE(USEROUT,*) '*** This scan can NOT be processed.'
            WRITE(USEROUT,*)
            GO TO 1000
          END IF
d511 1
a511 1
        CALL GETFACTR(IOPTION,PEAKUSED,NPIES,PSLOPES,BNKPAIRS,EFACTOR)
d535 1
a535 1
        CALL WRITERCD(N,RCDFILE,EFACTOR,VERSION)
d539 1
a539 1
        CALL WRITEHDR(DISK,EFACTOR,HDRNAME)
@


1.3
log
@modified RCSHEADER length
@
text
@d2 3
d81 6
d147 1
d171 1
a171 1
      DATA VERSION /'19-Oct-92'/
d203 1
a203 1
			RCSHEADER = "$Header: /home/petsun2/tom/programs/metproc/src/RCS/metproc.f,v 1.2 1992/10/16 22:32:51 tom Exp $"
d205 1
d231 1
a231 1
			DTANAME = SUBJECT(1:L)//'.DTA'
d235 4
a238 1
15		DTANAME = SUBJECT(1:L)//'.DAT'
d245 1
a245 1
8110	FORMAT('Neither blood curve file ',A,'.DTA nor ',A,'.DAT exists!')
d248 1
a248 1
			RCDNAME = SUBJECT(1:L)//'.RCD'
d264 5
d289 1
a289 1
        EXTENSION = '.HDR'
d331 1
a331 1
     &     .AND. IMGTYPE.NE.2000) THEN
d473 1
a473 1
        CALL METFILE(HDRNAME,SKIPSCAN)
@


1.2
log
@added RCSHEADER
@
text
@d1 4
a4 1
c $Log$
d145 1
a145 1
			CHARACTER*100 RCSHEADER
d161 1
a161 1
      DATA VERSION /'16-Oct-92'/
d193 1
a193 1
			RCSHEADER = "$Header$"
@


1.1
log
@Initial revision
@
text
@d1 1
d142 1
d158 1
a158 1
      DATA VERSION /'12-May-92'/
d190 1
@
